<!DOCTYPE html>
<html>
<head>
  <title>CreativeCrowdChallenge - Web App</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="A platform for creative challenges and competitions">
  <meta name="theme-color" content="#3b82f6">
  <link rel="manifest" href="/manifest.json">
  
  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CreativeCC">
  <link rel="apple-touch-icon" href="/assets/icon-192x192.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/assets/icon-192x192.png">
  
  <style>
    /* Base styles */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
      color: #333;
    }
    
    /* Header */
    header {
      background-color: #3B82F6;
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    
    /* Container */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Card styles */
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    /* Button styles */
    button {
      background-color: #3B82F6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: #2563EB;
    }

    button.secondary {
      background-color: #6B7280;
    }

    button.secondary:hover {
      background-color: #4B5563;
    }

    button.success {
      background-color: #10B981;
    }

    button.success:hover {
      background-color: #059669;
    }
    
    /* Tab navigation */
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      margin-right: 5px;
    }
    
    .tab.active {
      border-bottom: 3px solid #3B82F6;
      color: #3B82F6;
      font-weight: bold;
    }
    
    /* Screens */
    .screen {
      display: none;
    }
    
    .screen.active {
      display: block;
    }

    /* Form styles */
    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }

    textarea {
      min-height: 100px;
    }

    /* Badge */
    .badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 50px;
      font-size: 12px;
      background-color: #E5E7EB;
      margin-right: 5px;
    }

    .badge.primary {
      background-color: #DBEAFE;
      color: #1E40AF;
    }
    
    /* Social sharing styles */
    .share-buttons {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }
    
    .share-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f5f5f5;
      cursor: pointer;
      transition: background-color 0.3s;
      border: none;
      font-size: 18px;
    }
    
    .share-button:hover {
      background-color: #e0e0e0;
    }
    
    .share-button.twitter {
      background-color: #1DA1F2;
      color: white;
    }
    
    .share-button.facebook {
      background-color: #4267B2;
      color: white;
    }
    
    .share-button.linkedin {
      background-color: #0077B5;
      color: white;
    }
    
    .share-button.email {
      background-color: #D44638;
      color: white;
    }
    
    .share-button.clipboard {
      background-color: #6e6e6e;
      color: white;
    }

    .badge.success {
      background-color: #D1FAE5;
      color: #065F46;
    }

    /* Rating stars */
    .rating {
      display: flex;
      margin: 10px 0;
    }

    .star {
      color: #D1D5DB;
      font-size: 24px;
      cursor: pointer;
    }

    .star.filled {
      color: #F59E0B;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6B7280;
      padding: 0;
    }

    /* Notification container */
    #notification-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column-reverse;
      gap: 10px;
      max-width: 300px;
    }
    
    /* Notification styling */
    .notification {
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      position: relative;
      animation: slide-in 0.3s ease-out forwards;
      opacity: 0;
      transform: translateX(30px);
      margin-bottom: 8px;
      overflow: hidden;
      font-size: 15px;
      line-height: 1.5;
      display: none;
    }
    
    /* Notification types */
    .notification.success {
      background-color: #10B981;
    }
    
    .notification.error {
      background-color: #EF4444;
    }
    
    .notification.info {
      background-color: #3B82F6;
    }
    
    .notification.warning {
      background-color: #F59E0B;
    }
    
    /* Animations */
    @keyframes slide-in {
      0% {
        opacity: 0;
        transform: translateX(30px);
      }
      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slide-out {
      0% {
        opacity: 1;
        transform: translateX(0);
      }
      100% {
        opacity: 0;
        transform: translateX(30px);
      }
    }
    
    @keyframes slide-in {
      0% { transform: translateX(100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slide-out {
      0% { transform: translateX(0); opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
    }
    
    /* App installation prompt */
    #install-prompt {
      margin-top: 20px;
      padding: 15px;
      background-color: #e6f7ff;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      border-left: 4px solid #3B82F6;
      animation: slide-in 0.5s ease-out forwards;
    }
    
    #install-prompt p {
      margin: 0 0 12px 0;
      font-weight: 500;
      display: flex;
      align-items: center;
    }
    
    #install-prompt p::before {
      content: "📱";
      margin-right: 10px;
      font-size: 1.2em;
    }
    
    #install-prompt .button-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    #install-button {
      background-color: #3B82F6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    
    #install-button:hover {
      background-color: #2563EB;
    }
    
    #dismiss-install {
      background-color: transparent;
      border: 1px solid #9CA3AF;
      color: #6B7280;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s, border-color 0.2s;
    }
    
    #dismiss-install:hover {
      background-color: #F3F4F6;
      border-color: #6B7280;
    }

    /* Profile header */
    .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-color: #3B82F6;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 28px;
      margin-right: 20px;
    }

    .profile-info {
      flex: 1;
    }

    /* Competition details */
    .competition-header {
      position: relative;
      padding-bottom: 10px;
      border-bottom: 1px solid #E5E7EB;
      margin-bottom: 15px;
    }

    .competition-meta {
      display: flex;
      margin-bottom: 10px;
    }

    .meta-item {
      margin-right: 20px;
      font-size: 14px;
      color: #6B7280;
    }

    /* Stats */
    .stats-container {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .stat-box {
      flex: 1;
      min-width: 100px;
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      margin: 0 5px 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #3B82F6;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: #6B7280;
    }

    /* Back button */
    .back-button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      position: absolute;
      left: 20px;
      top: 20px;
    }

    .back-icon {
      margin-right: 5px;
    }

    /* Tab content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Login form */
    .auth-options {
      display: flex;
      margin-bottom: 20px;
    }

    .auth-option {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      border-bottom: 2px solid #E5E7EB;
    }

    .auth-option.active {
      border-bottom: 2px solid #3B82F6;
      color: #3B82F6;
      font-weight: bold;
    }

    /* Analytics styles */
    .chart-container {
      position: relative;
      margin: 20px 0;
      height: 300px;
    }
    
    .analytics-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    
    .analytics-table th, 
    .analytics-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #E5E7EB;
    }
    
    .analytics-table th {
      background-color: #F9FAFB;
      font-weight: 600;
    }
    
    .analytics-table tr:hover {
      background-color: #F9FAFB;
    }
    
    .metric-card {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 8px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .metric-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #EBF5FF;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 20px;
      color: #3B82F6;
    }
    
    .metric-info {
      flex: 1;
    }
    
    .metric-label {
      font-size: 14px;
      color: #6B7280;
      margin-bottom: 5px;
    }
    
    .metric-value {
      font-size: 20px;
      font-weight: bold;
    }
    
    .trend-up {
      color: #10B981;
    }
    
    .trend-down {
      color: #EF4444;
    }
    
    /* Enhanced analytics styles */
    .metrics-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .engagement-metric-card {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
    }
    
    .engagement-metric-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .metric-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .metric-header-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #EBF5FF;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-size: 16px;
      color: #3B82F6;
    }
    
    .metric-title {
      font-size: 14px;
      color: #4B5563;
      font-weight: 600;
      margin: 0;
    }
    
    .metric-data {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      margin: 5px 0;
    }
    
    .metric-trend {
      font-size: 12px;
      display: flex;
      align-items: center;
    }
    
    .dual-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 768px) {
      .dual-container {
        grid-template-columns: 1fr;
      }
    }
    
    .engagement-stats-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .engagement-stat {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .engagement-stat h4 {
      margin: 0 0 10px 0;
      color: #4B5563;
      font-size: 14px;
    }
    
    .stat-large {
      font-size: 28px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 5px;
    }
    
    .trend-indicator {
      font-size: 12px;
      display: flex;
      align-items: center;
      margin-top: 5px;
    }
    
    .insights-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .insight-card {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .insight-card h4 {
      margin: 0 0 10px 0;
      color: #4B5563;
      font-size: 14px;
    }
    
    .insight-value {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 5px;
    }
    
    .insight-trend {
      font-size: 12px;
      display: flex;
      align-items: center;
    }
    
    .source-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #E5E7EB;
    }
    
    .source-name {
      font-weight: 500;
    }
    
    .source-percentage {
      font-weight: 600;
      color: #3B82F6;
    }
    
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      font-size: 12px;
    }
    
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      margin-right: 5px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .card {
        padding: 15px;
      }
      
      .tabs {
        padding: 0 10px;
      }
      
      .stat-box {
        min-width: calc(50% - 20px);
        margin-bottom: 10px;
      }
      
      .chart-container {
        height: 250px;
      }
      
      .analytics-table {
        font-size: 14px;
      }
      
      .analytics-table th, 
      .analytics-table td {
        padding: 8px;
      }
    }
    
    /* Submission styles */
    .submission-item {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #fff;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .submission-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .submission-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .submission-header h4 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }
    
    .submission-date {
      font-size: 14px;
      color: #666;
    }
    
    .submission-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
    }
    
    .votes-container {
      display: flex;
      align-items: center;
    }
    
    .votes-count {
      font-size: 18px;
      font-weight: bold;
      color: #3B82F6;
      margin-right: 5px;
      transition: transform 0.3s, color 0.3s;
    }
    
    .votes-label {
      font-size: 14px;
      color: #666;
    }
    
    .vote-button {
      background-color: #10B981;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: background-color 0.2s;
    }
    
    .vote-button:hover {
      background-color: #059669;
    }
    
    .vote-button.disabled {
      background-color: #9CA3AF;
      cursor: not-allowed;
    }
    
    .vote-icon {
      margin-right: 5px;
    }
    
    .vote-added {
      transform: scale(1.2);
      color: #10B981;
      animation: pulse 0.5s;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1.2); }
    }
  </style>
</head>
<body>
  <header id="main-header">
    <h1>CreativeCrowdChallenge</h1>
    <p>Connect with creative competitions</p>
    <div id="offline-notification" style="display: none; background-color: #ffe66d; color: #333; padding: 8px; text-align: center; font-weight: bold; margin-top: 10px;">
      You are currently offline. Some features may be limited.
    </div>
    <!-- Add to Home Screen Prompt -->
    <div id="install-prompt" style="display: none;">
      <p>Add this app to your home screen for a better experience!</p>
      <div class="button-container">
        <button id="install-button">Install App</button>
        <button id="dismiss-install">Later</button>
      </div>
    </div>
  </header>
  
  <div class="container">
    
    <!-- Tab Navigation -->
    <div class="tabs">
      <div class="tab active" data-screen="home">Home</div>
      <div class="tab" data-screen="individual">Individual</div>
      <div class="tab" data-screen="business">Business</div>
      <div class="tab" data-screen="submit">Submit</div>
      <div class="tab" data-screen="profile">Login</div>
    </div>
    
    <!-- Home Screen -->
    <div id="home-screen" class="screen active">
      <div class="card">
        <h2>Welcome to CreativeCrowdChallenge!</h2>
        <p>Join exciting creative competitions and showcase your talents.</p>
        <button onclick="showScreen('individual')">Explore Individual Competitions</button>
        <button onclick="showScreen('business')" class="secondary">Explore Business Competitions</button>
      </div>
      
      <div class="stats-container">
        <div class="stat-box">
          <div class="stat-value">15</div>
          <div class="stat-label">Active Competitions</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">256</div>
          <div class="stat-label">Participants</div>
        </div>
        <div class="stat-box">
          <div class="stat-value">42</div>
          <div class="stat-label">Winners Crowned</div>
        </div>
      </div>
      
      <!-- AI Recommendations Section -->
      <div class="card" style="margin-bottom: 20px; background-color: #f9f7ff; border-left: 4px solid #6d28d9;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h3 style="color: #6d28d9; margin: 0;">AI-Powered Recommendations</h3>
          <button onclick="toggleRecommendationsPreview()" id="preview-toggle-btn" class="secondary" style="font-size: 0.85rem; padding: 5px 10px;">
            Show Preview
          </button>
        </div>
        <p style="margin-bottom: 15px;">Competitions tailored to your interests and profile</p>
        
        <div id="interests-container" style="margin-bottom: 15px;">
          <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <label for="interests-input" style="margin-right: 10px; font-weight: bold;">My Interests:</label>
            <input type="text" id="interests-input" placeholder="design, writing, marketing, photography, music" style="flex-grow: 1;">
          </div>
          <small style="display: block; color: #6B7280;">Enter comma-separated interests to improve recommendations</small>
        </div>
        
        <button onclick="loadRecommendations()" style="background-color: #6d28d9; width: 100%;">Get Personalized Recommendations</button>
        
        <div id="recommendations-container" style="margin-top: 15px; display: none;">
          <div class="loading-animation" id="recommendations-loading">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </div>
          <div id="recommendations-list"></div>
        </div>
      </div>
      
      <div class="card">
        <h3>Popular Categories</h3>
        <div style="margin: 15px 0;">
          <span class="badge primary">Photography</span>
          <span class="badge primary">Digital Art</span>
          <span class="badge primary">Writing</span>
          <span class="badge primary">Music</span>
          <span class="badge primary">Video</span>
          <span class="badge primary">Graphic Design</span>
        </div>
        <button onclick="showCategorySuggestionModal()" class="secondary">Suggest a Category</button>
      </div>
    </div>
    
    <!-- Individual Competitions Screen -->
    <div id="individual-screen" class="screen">
      <div class="card">
        <h2>Individual Competitions</h2>
        <p>Free competitions open to all creative individuals.</p>
        <div id="individual-competitions-list">
          <div class="card">
            <h3>Summer Photography Contest</h3>
            <div class="competition-meta">
              <div class="meta-item"><strong>Ends:</strong> Apr 15, 2025</div>
              <div class="meta-item"><strong>Entries:</strong> 24</div>
            </div>
            <p>Show your best summer shots and win prizes!</p>
            <div>
              <span class="badge primary">Photography</span>
              <span class="badge success">Cash Prize</span>
            </div>
            <div style="margin-top: 15px;">
              <button onclick="showCompetitionDetails('photo-contest')">View Details</button>
            </div>
          </div>
          <div class="card">
            <h3>Creative Writing Challenge</h3>
            <div class="competition-meta">
              <div class="meta-item"><strong>Ends:</strong> Apr 30, 2025</div>
              <div class="meta-item"><strong>Entries:</strong> 18</div>
            </div>
            <p>Write a short story on the theme "New Beginnings"</p>
            <div>
              <span class="badge primary">Writing</span>
              <span class="badge success">Featured Publication</span>
            </div>
            <div style="margin-top: 15px;">
              <button onclick="showCompetitionDetails('writing-challenge')">View Details</button>
            </div>
          </div>
          <div class="card">
            <h3>Melody Makers Music Competition</h3>
            <div class="competition-meta">
              <div class="meta-item"><strong>Ends:</strong> May 10, 2025</div>
              <div class="meta-item"><strong>Entries:</strong> 7</div>
            </div>
            <p>Compose an original 2-minute piece in any genre</p>
            <div>
              <span class="badge primary">Music</span>
              <span class="badge success">Studio Time</span>
            </div>
            <div style="margin-top: 15px;">
              <button onclick="showCompetitionDetails('music-competition')">View Details</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Business Competitions Screen -->
    <div id="business-screen" class="screen">
      <div class="card">
        <h2>Business Competitions</h2>
        <p>Premium competitions sponsored by businesses with higher rewards. Requires a business subscription to create competitions.</p>
        <div id="business-competitions-list">
          <!-- Business competitions will be loaded here -->
          <div class="card">
            <h3>Logo Design Challenge</h3>
            <div class="competition-meta">
              <div class="meta-item"><strong>Ends:</strong> Apr 30, 2025</div>
              <div class="meta-item"><strong>Entries:</strong> 24</div>
              <div class="meta-item"><strong>Prize:</strong> $500</div>
            </div>
            <p>Create a modern logo for a tech startup</p>
            <div>
              <span class="badge primary">Design</span>
              <span class="badge success">Business</span>
            </div>
            <div style="margin-top: 15px;">
              <button onclick="showCompetitionDetails('mock-comp-1')">View Details</button>
            </div>
          </div>
          <div class="card">
            <h3>Mobile App UI Challenge</h3>
            <div class="competition-meta">
              <div class="meta-item"><strong>Ends:</strong> May 15, 2025</div>
              <div class="meta-item"><strong>Entries:</strong> 12</div>
              <div class="meta-item"><strong>Prize:</strong> $750</div>
            </div>
            <p>Design an intuitive mobile interface for a fitness app</p>
            <div>
              <span class="badge primary">Design</span>
              <span class="badge success">Business</span>
            </div>
            <div style="margin-top: 15px;">
              <button onclick="showCompetitionDetails('mock-comp-2')">View Details</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Submit Screen -->
    <div id="submit-screen" class="screen">
      <div class="card">
        <h2>Submit Your Entry</h2>
        <p>Select a competition and submit your creative work.</p>
        
        <form id="submission-form">
          <div class="form-group">
            <label for="competition-select">Select Competition</label>
            <select id="competition-select" required>
              <option value="">-- Select a competition --</option>
              <option value="photo-contest">Summer Photography Contest</option>
              <option value="writing-challenge">Creative Writing Challenge</option>
              <option value="music-competition">Melody Makers Music Competition</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="submission-title">Title of Your Work</label>
            <input type="text" id="submission-title" placeholder="Give your submission a title" required>
          </div>
          
          <div class="form-group">
            <label for="submission-description">Description</label>
            <textarea id="submission-description" placeholder="Tell us about your work..." required></textarea>
          </div>
          
          <div class="form-group">
            <label for="submission-file">Upload Your Work</label>
            <input type="file" id="submission-file">
            <p style="font-size: 14px; color: #6B7280; margin-top: 5px;">Max file size: 10MB. Supported formats depend on the competition category.</p>
          </div>
          
          <div class="form-group">
            <button type="button" onclick="submitEntry()" class="success">Submit Entry</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Profile Screen -->
    <div id="profile-screen" class="screen">
      <div id="profile-logged-out">
        <div class="card">
          <h2>Login or Register</h2>
          
          <div class="auth-options">
            <div class="auth-option active" onclick="showAuthTab('login')">Login</div>
            <div class="auth-option" onclick="showAuthTab('register')">Register</div>
          </div>
          
          <div id="login-tab" class="tab-content active">
            <form id="login-form">
              <div class="form-group">
                <label for="login-email">Email</label>
                <input type="email" id="login-email" placeholder="your@email.com" required>
              </div>
              <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" placeholder="Your password" required>
                <small style="display: block; margin-top: 5px; color: #6B7280;">Password must be at least 6 characters long</small>
              </div>
              <div class="form-group">
                <button type="button" onclick="login()">Login</button>
              </div>
              
              <div style="text-align: center; margin: 20px 0; position: relative;">
                <hr style="margin: 0; border: none; border-top: 1px solid #E5E7EB;">
                <span style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; color: #6B7280;">or</span>
              </div>
              
              <div class="form-group">
                <button type="button" onclick="loginWithGoogle()" style="background-color: white; color: #333; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: normal;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                  </svg>
                  Sign in with Google
                </button>
              </div>
            </form>
          </div>
          
          <div id="register-tab" class="tab-content">
            <form id="register-form">
              <div class="form-group">
                <label for="register-name">Full Name</label>
                <input type="text" id="register-name" placeholder="Your name" required>
              </div>
              <div class="form-group">
                <label for="register-email">Email</label>
                <input type="email" id="register-email" placeholder="your@email.com" required>
              </div>
              <div class="form-group">
                <label for="register-password">Password</label>
                <input type="password" id="register-password" placeholder="Choose a password" required>
                <small style="display: block; margin-top: 5px; color: #6B7280;">Password must be at least 6 characters long</small>
              </div>
              <div class="form-group">
                <button type="button" onclick="register()">Register</button>
              </div>
              
              <div style="text-align: center; margin: 20px 0; position: relative;">
                <hr style="margin: 0; border: none; border-top: 1px solid #E5E7EB;">
                <span style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; color: #6B7280;">or</span>
              </div>
              
              <div class="form-group">
                <button type="button" onclick="loginWithGoogle()" style="background-color: white; color: #333; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: normal;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                  </svg>
                  Sign up with Google
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <div id="profile-logged-in" style="display: none;">
        <div class="profile-header">
          <div class="profile-avatar">DU</div>
          <div class="profile-info">
            <h2 id="profile-user-name">Demo User</h2>
            <p id="profile-member-since">Member since March 2023</p>
            <p id="profile-user-role" style="font-style: italic; color: #6B7280;">Regular User</p>
          </div>
        </div>
        
        <div class="stats-container">
          <div class="stat-box">
            <div class="stat-value" id="profile-submissions">5</div>
            <div class="stat-label">Submissions</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="profile-awards">2</div>
            <div class="stat-label">Awards</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="profile-votes">12</div>
            <div class="stat-label">Votes Cast</div>
          </div>
        </div>
        
        <!-- Back Office section for admin and business users -->
        <div id="back-office-section" class="card" style="display: none; margin-bottom: 20px; background-color: #F8FAFC; border-left: 4px solid #3B82F6;">
          <h3 style="color: #1E40AF;">Back Office</h3>
          <p>Access special features for businesses and administrators.</p>
          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button onclick="showRequestAnalyticsForm()" style="background-color: #1E40AF;">Request Analytics Report</button>
          </div>
        </div>
        
        <div class="card">
          <h3>My Submissions</h3>
          <div class="card">
            <h4>Sunset at the Beach</h4>
            <div class="competition-meta">
              <div class="meta-item"><strong>Competition:</strong> Summer Photography Contest</div>
              <div class="meta-item"><strong>Status:</strong> Under Review</div>
            </div>
            <div class="share-buttons">
              <button class="share-button twitter" title="Share on Twitter" onclick="shareContent('twitter', 'Sunset at the Beach', 'Check out my submission to the Summer Photography Contest')">
                T
              </button>
              <button class="share-button facebook" title="Share on Facebook" onclick="shareContent('facebook', 'Sunset at the Beach', 'My submission to the Summer Photography Contest')">
                f
              </button>
              <button class="share-button linkedin" title="Share on LinkedIn" onclick="shareContent('linkedin', 'Sunset at the Beach', 'My photography submission')">
                in
              </button>
              <button class="share-button email" title="Share via Email" onclick="shareContent('email', 'My Photography Submission', 'Check out my submission to the Summer Photography Contest')">
                ✉
              </button>
              <button class="share-button clipboard" title="Copy Link" onclick="shareContent('clipboard', 'Sunset at the Beach', 'My summer photography submission')">
                📋
              </button>
            </div>
            <div style="margin-top: 15px;">
              <button onclick="alert('View submission details')">View Details</button>
            </div>
          </div>
          <div class="card">
            <h4>New Day Rising</h4>
            <div class="competition-meta">
              <div class="meta-item"><strong>Competition:</strong> Creative Writing Challenge</div>
              <div class="meta-item"><strong>Status:</strong> Runner-up</div>
            </div>
            <div class="share-buttons">
              <button class="share-button twitter" title="Share on Twitter" onclick="shareContent('twitter', 'New Day Rising', 'Read my submission to the Creative Writing Challenge!')">
                T
              </button>
              <button class="share-button facebook" title="Share on Facebook" onclick="shareContent('facebook', 'New Day Rising', 'My writing submission')">
                f
              </button>
              <button class="share-button linkedin" title="Share on LinkedIn" onclick="shareContent('linkedin', 'New Day Rising', 'My award-winning short story')">
                in
              </button>
              <button class="share-button email" title="Share via Email" onclick="shareContent('email', 'My Writing Submission', 'I wanted to share my Creative Writing Challenge entry with you')">
                ✉
              </button>
              <button class="share-button clipboard" title="Copy Link" onclick="shareContent('clipboard', 'New Day Rising', 'My writing submission')">
                📋
              </button>
            </div>
            <div style="margin-top: 15px;">
              <button onclick="alert('View submission details')">View Details</button>
            </div>
          </div>
        </div>
        

        
        <button onclick="logout()" class="secondary">Logout</button>
      </div>
    </div>
    
    <!-- Analytics Screen -->
    <div id="analytics-screen" class="screen">
      <div class="card">
        <h2>Business Analytics</h2>
        <p>Track engagement and performance for your competitions.</p>
        
        <div id="business-selector-container" class="form-group">
          <label for="business-selector">Select Business</label>
          <select id="business-selector" onchange="loadBusinessAnalytics()">
            <option value="mock-business-1">TechCreate Solutions</option>
            <option value="mock-business-2">EcoDesign Innovations</option>
          </select>
        </div>
      </div>
      
      <div class="stats-container">
        <div class="stat-box">
          <div class="stat-value" id="total-competitions">3</div>
          <div class="stat-label">Total Competitions</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="total-submissions">42</div>
          <div class="stat-label">Total Submissions</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="total-views">1.2k</div>
          <div class="stat-label">Total Views</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="avg-engagement">32%</div>
          <div class="stat-label">Avg. Engagement</div>
        </div>
      </div>
      
      <div class="card">
        <h3>Competition Performance</h3>
        <div id="competitions-chart" class="chart-container">
          <!-- Canvas will be created dynamically -->
        </div>
      </div>
      
      <div class="card">
        <h3>Demographic Breakdown</h3>
        <div id="demographics-chart" class="chart-container">
          <!-- Canvas will be created dynamically -->
        </div>
        <div id="geo-data-container" class="regions-container">
          <!-- Will be populated dynamically -->
        </div>
      </div>
      
      <div class="card">
        <h3>Device Usage Analytics</h3>
        <div class="device-analytics-container">
          <div class="device-chart-container">
            <canvas id="device-usage-chart"></canvas>
          </div>
          <div class="device-metrics">
            <div class="device-metric">
              <h4>Mobile</h4>
              <div class="device-percentage" id="mobile-percentage">65%</div>
              <div class="device-icon">📱</div>
            </div>
            <div class="device-metric">
              <h4>Desktop</h4>
              <div class="device-percentage" id="desktop-percentage">30%</div>
              <div class="device-icon">🖥️</div>
            </div>
            <div class="device-metric">
              <h4>Tablet</h4>
              <div class="device-percentage" id="tablet-percentage">5%</div>
              <div class="device-icon">📑</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Competition Performance Metrics</h3>
        <div class="competition-performance-grid">
          <div class="performance-metric">
            <div class="metric-label">Average Submissions</div>
            <div class="metric-value" id="avg-submissions-per-competition">21.0</div>
            <div class="metric-icon">📊</div>
          </div>
          <div class="performance-metric">
            <div class="metric-label">Completion Rate</div>
            <div class="metric-value" id="submission-completion-rate">85%</div>
            <div class="metric-icon">✓</div>
          </div>
          <div class="performance-metric">
            <div class="metric-label">Average Duration</div>
            <div class="metric-value" id="avg-competition-duration">24 days</div>
            <div class="metric-icon">⏱️</div>
          </div>
          <div class="performance-metric">
            <div class="metric-label">Top Category</div>
            <div class="metric-value" id="top-performing-category">Design</div>
            <div class="metric-icon">🏆</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Submission Analytics</h3>
        <table class="analytics-table">
          <thead>
            <tr>
              <th>Competition</th>
              <th>Submissions</th>
              <th>Views</th>
              <th>Engagement Rate</th>
            </tr>
          </thead>
          <tbody id="analytics-table-body">
            <tr>
              <td>Logo Design Challenge</td>
              <td>24</td>
              <td>487</td>
              <td>4.9%</td>
            </tr>
            <tr>
              <td>Mobile App UI Challenge</td>
              <td>12</td>
              <td>295</td>
              <td>4.1%</td>
            </tr>
            <tr>
              <td>Marketing Campaign Concept</td>
              <td>6</td>
              <td>218</td>
              <td>2.8%</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="card">
        <h3>Enhanced User Engagement Metrics</h3>
        <div id="engagement-metrics" class="metrics-container">
          <!-- Enhanced metrics cards -->
          <div class="engagement-metric-card">
            <div class="metric-header">
              <div class="metric-header-icon">📈</div>
              <h4 class="metric-title">Daily Engagement</h4>
            </div>
            <div class="metric-data" id="daily-engagement">32</div>
            <div class="metric-trend trend-up">+15% from last week</div>
          </div>
          
          <div class="engagement-metric-card">
            <div class="metric-header">
              <div class="metric-header-icon">🔄</div>
              <h4 class="metric-title">Weekly Trend</h4>
            </div>
            <div class="metric-data" id="weekly-trend">+15%</div>
            <div class="metric-trend trend-up">Growing steadily</div>
          </div>
          
          <div class="engagement-metric-card">
            <div class="metric-header">
              <div class="metric-header-icon">🎯</div>
              <h4 class="metric-title">Conversion Rate</h4>
            </div>
            <div class="metric-data" id="conversion-rate">3.8%</div>
            <div class="metric-trend trend-up">+0.5% from last month</div>
          </div>
          
          <div class="engagement-metric-card">
            <div class="metric-header">
              <div class="metric-header-icon">⏱️</div>
              <h4 class="metric-title">Avg. Time Spent</h4>
            </div>
            <div class="metric-data" id="avg-time">4.5 min</div>
            <div class="metric-trend trend-up">+0.8 min from last period</div>
          </div>
        </div>
        <div id="engagement-chart" class="chart-container">
          <!-- Canvas will be created dynamically -->
          <canvas id="engagement-line-chart"></canvas>
        </div>
      </div>
      
      <div class="card">
        <h3>Traffic Sources Analysis</h3>
        <div class="dual-container">
          <div id="sources-chart" class="chart-container">
            <!-- Canvas will be created dynamically -->
            <canvas id="traffic-sources-chart"></canvas>
            <div class="chart-legend" id="traffic-sources-legend">
              <!-- Legend will be populated dynamically -->
            </div>
          </div>
          <div class="engagement-stats-container">
            <div class="engagement-stat">
              <h4>Most Active Time</h4>
              <div id="peak-time" class="stat-large">2pm - 6pm</div>
              <div class="trend-indicator trend-up">+12% from last period</div>
            </div>
            <div class="engagement-stat">
              <h4>Avg. Session Duration</h4>
              <div id="session-duration" class="stat-large">4.5 min</div>
              <div class="trend-indicator trend-up">+0.8 min from last period</div>
            </div>
            <div id="traffic-sources-list" class="source-stats">
              <!-- Will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>User Behavior Insights</h3>
        <div class="insights-container">
          <div class="insight-card">
            <h4>Returning Users</h4>
            <div class="insight-value" id="returning-users">68%</div>
            <div class="insight-trend trend-up">+5% from last period</div>
          </div>
          <div class="insight-card">
            <h4>Avg. Votes per User</h4>
            <div class="insight-value" id="votes-per-user">8.2</div>
            <div class="insight-trend trend-up">+1.4 from last period</div>
          </div>
          <div class="insight-card">
            <h4>Submission Quality</h4>
            <div class="insight-value" id="submission-quality">4.2★</div>
            <div class="insight-trend trend-up">+0.3 from last period</div>
          </div>
          <div class="insight-card">
            <h4>User Retention</h4>
            <div class="insight-value" id="user-retention">71%</div>
            <div class="insight-trend trend-up">+7% from last period</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Engagement Timeline</h3>
        <div class="timeline-filters">
          <select id="timeline-period" onchange="loadBusinessAnalytics()">
            <option value="7days">Last 7 days</option>
            <option value="30days" selected>Last 30 days</option>
            <option value="90days">Last 90 days</option>
          </select>
        </div>
        <div id="timeline-chart" class="chart-container">
          <!-- Canvas will be created dynamically -->
        </div>
      </div>
      
      <div class="card">
        <h3>Export Options</h3>
        <div style="display: flex; gap: 10px;">
          <button onclick="exportAnalytics('csv')" class="secondary">Export as CSV</button>
          <button onclick="exportAnalytics('pdf')" class="secondary">Export as PDF</button>
          <button onclick="exportAnalytics('json')" class="secondary">Export Raw Data</button>
        </div>
      </div>
      
      <div class="card" id="analytics-request-card">
        <h3>Request Detailed Analytics</h3>
        <p>Need more detailed analytics for your competitions? Submit a request and our team will provide you with a comprehensive report.</p>
        
        <form id="analytics-request-form" onsubmit="submitAnalyticsRequest(event)">
          <div class="form-group">
            <label for="competition-selector">Select Competition</label>
            <select id="competition-selector" required>
              <option value="">Select a competition</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          
          <div class="form-group">
            <label for="date-range">Time Period</label>
            <select id="date-range" required>
              <option value="last-30-days">Last 30 Days</option>
              <option value="last-90-days">Last 90 Days</option>
              <option value="last-6-months">Last 6 Months</option>
              <option value="last-year">Last Year</option>
              <option value="all-time">All Time</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="request-details">Additional Details (Optional)</label>
            <textarea id="request-details" placeholder="Specify any particular metrics or insights you're interested in..."></textarea>
          </div>
          
          <div class="form-group">
            <button type="submit" class="primary" id="submit-request-btn">Submit Request</button>
            <div id="request-status" class="request-status"></div>
          </div>
        </form>
        
        <div id="analytics-requests-list" class="analytics-requests-container">
          <h4>Your Requests</h4>
          <div class="requests-list" id="user-analytics-requests">
            <!-- Will be populated dynamically -->
            <div class="empty-state" id="no-requests-message">
              You haven't submitted any analytics requests yet.
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <style>
      /* Enhanced Analytics Styles */
      .metrics-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
      }
      
      /* Device Usage Analytics */
      .device-analytics-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }
      
      .device-chart-container {
        flex: 2;
        min-width: 280px;
      }
      
      .device-metrics {
        flex: 1;
        min-width: 200px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      
      .device-metric {
        background-color: #fff;
        border-radius: 8px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      
      .device-percentage {
        font-size: 26px;
        font-weight: 600;
        margin: 8px 0;
      }
      
      .device-icon {
        font-size: 28px;
        margin-top: 4px;
      }
      
      /* Competition Performance Metrics */
      .competition-performance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
        margin-top: 10px;
      }
      
      .performance-metric {
        background-color: #fff;
        border-radius: 8px;
        padding: 18px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        position: relative;
      }
      
      .metric-icon {
        font-size: 24px;
        margin-top: 8px;
      }
      
      .metric-label {
        color: #64748b;
        font-size: 14px;
        margin-bottom: 6px;
      }
      
      .metric-value {
        font-size: 22px;
        font-weight: 600;
      }
      
      /* Geographic Data */
      .regions-container {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 15px;
      }
      
      .region-item {
        flex: 1;
        min-width: 140px;
        background-color: #fff;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .region-name {
        font-size: 14px;
        color: #64748b;
      }
      
      .region-percentage {
        font-weight: 600;
        font-size: 16px;
      }
      
      .metric-card {
        display: flex;
        align-items: center;
        background: #f8fafc;
        border-radius: 8px;
        padding: 15px;
        flex: 1;
        min-width: 200px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      
      .dual-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }
      
      .dual-container .chart-container {
        flex: 2;
        min-width: 300px;
      }
      
      .engagement-stats-container {
        flex: 1;
        min-width: 200px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      
      .engagement-stat {
        background: #f8fafc;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      
      .engagement-stat h4 {
        margin: 0 0 10px 0;
        color: #64748b;
        font-size: 14px;
      }
      
      .stat-large {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 5px;
      }
      
      .trend-indicator {
        font-size: 12px;
        display: flex;
        align-items: center;
      }
      
      .insights-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 10px;
      }
      
      .insight-card {
        background: #f8fafc;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      
      .insight-card h4 {
        margin: 0 0 10px 0;
        color: #64748b;
        font-size: 14px;
      }
      
      .insight-value {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 5px;
      }
      
      .insight-trend {
        font-size: 12px;
      }
      
      .timeline-filters {
        margin-bottom: 15px;
        display: flex;
        justify-content: flex-end;
      }
      
      .timeline-filters select {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        background-color: #f8fafc;
        font-size: 14px;
      }
      
      @media (max-width: 768px) {
        .dual-container {
          flex-direction: column;
        }
        
        .metrics-container {
          flex-direction: column;
        }
        
        .insights-container {
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
      }
      
      /* Analytics Request Styles */
      .analytics-requests-container {
        margin-top: 25px;
      }
      
      .requests-list {
        margin-top: 15px;
      }
      
      .request-item {
        background-color: #f8fafc;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      
      .request-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      
      .request-title {
        font-weight: 600;
        font-size: 16px;
      }
      
      .request-date {
        font-size: 14px;
        color: #64748b;
      }
      
      .request-status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        margin-top: 10px;
      }
      
      .status-pending {
        background-color: #fffbeb;
        color: #d97706;
      }
      
      .status-approved {
        background-color: #ecfdf5;
        color: #10b981;
      }
      
      .status-rejected {
        background-color: #fef2f2;
        color: #ef4444;
      }
      
      .status-completed {
        background-color: #f0f9ff;
        color: #0ea5e9;
      }
      
      .request-details {
        font-size: 14px;
        margin-top: 10px;
        color: #475569;
      }
      
      .empty-state {
        text-align: center;
        padding: 30px;
        color: #64748b;
        font-style: italic;
      }
      
      .request-status {
        margin-top: 10px;
        font-size: 14px;
        height: 20px;
      }
    </style>
    
    <!-- Competition Details Screen (hidden by default) -->
    <div id="competition-details-screen" class="screen">
      <div class="card">
        <div class="competition-header">
          <h2 id="competition-title">Competition Title</h2>
          <div class="competition-meta">
            <div class="meta-item"><strong>Deadline:</strong> <span id="competition-deadline">April 15, 2025</span></div>
            <div class="meta-item"><strong>Entries:</strong> <span id="competition-entries">24</span></div>
          </div>
          <div id="competition-categories">
            <span class="badge primary">Category</span>
          </div>
        </div>
        
        <div id="competition-description">
          <p>Competition description will appear here.</p>
        </div>
        
        <h3>Prizes</h3>
        <ul id="competition-prizes">
          <li>First place: $100</li>
          <li>Runner-up: $50</li>
        </ul>
        
        <h3>Rules</h3>
        <ul id="competition-rules">
          <li>All submissions must be original work</li>
          <li>One submission per participant</li>
        </ul>
        
        <h3>Share This Competition</h3>
        <div class="share-buttons">
          <button class="share-button twitter" title="Share on Twitter" onclick="shareContent('twitter', 'Competition Title', 'Check out this creative competition')">
            T
          </button>
          <button class="share-button facebook" title="Share on Facebook" onclick="shareContent('facebook', 'Competition Title', 'Join this creative competition')">
            f
          </button>
          <button class="share-button linkedin" title="Share on LinkedIn" onclick="shareContent('linkedin', 'Competition Title', 'Participate in this competition')">
            in
          </button>
          <button class="share-button email" title="Share via Email" onclick="shareContent('email', 'Competition Title', 'I thought you might be interested in this competition')">
            ✉
          </button>
          <button class="share-button clipboard" title="Copy Link" onclick="shareContent('clipboard', 'Competition Title', 'Check out this competition')">
            📋
          </button>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button onclick="showScreen('submit')">Submit Entry</button>
          <button onclick="showScreen('competitions')" class="secondary">Back to List</button>
        </div>
      </div>
      
      <div class="card">
        <h3>Top Submissions</h3>
        <div id="submissions-list">
          <p>Submissions will be displayed once the competition has ended.</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modals -->
  <div id="category-suggestion-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Suggest a Category</h3>
        <button class="close-modal" onclick="closeCategorySuggestionModal()">&times;</button>
      </div>
      <form id="category-suggestion-form">
        <div class="form-group">
          <label for="category-name">Category Name</label>
          <input type="text" id="category-name" placeholder="e.g., Animation" required>
        </div>
        <div class="form-group">
          <label for="category-description">Why should we add this category?</label>
          <textarea id="category-description" placeholder="Tell us about this creative category..." required></textarea>
        </div>
        <div class="form-group">
          <button type="button" onclick="submitCategorySuggestion()">Submit Suggestion</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Notification -->
  <!-- Notifications will be dynamically created -->
  
  <!-- Include Chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/assets/js/indexedDBHelper.js"></script>
  
  <script>
    // Global state
    let isLoggedIn = false;
    let currentUser = null;
    let authToken = null;
    let competitions = {}; // Will be populated from API
    
    // Tab functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const screenName = this.getAttribute('data-screen') + '-screen';
        showScreen(screenName);
      });
    });
    
    // Function to show a specific screen
    function showScreen(screenName) {
      // Ensure screen name has proper suffix
      const fullScreenName = screenName.endsWith('-screen') ? screenName : screenName + '-screen';
      
      // Special case for competition details to add back button
      if (fullScreenName === 'competition-details-screen') {
        // Get the last screen the user was on (either individual or business)
        const lastScreen = localStorage.getItem('lastCompetitionScreen') || 'individual';
        document.getElementById('main-header').innerHTML = `
          <button class="back-button" onclick="showScreen('${lastScreen}')">
            <span class="back-icon">←</span> Back
          </button>
          <h1>Competition Details</h1>
        `;
      } else {
        document.getElementById('main-header').innerHTML = `
          <h1>CreativeCrowdChallenge</h1>
          <p>Connect with creative competitions</p>
        `;
      }
    
      // Hide all screens
      document.querySelectorAll('.screen').forEach(screen => {
        screen.style.display = 'none';
      });
      
      // Show the requested screen
      const screenElement = document.getElementById(fullScreenName);
      if (screenElement) {
        screenElement.style.display = 'block';
        console.log("Showing screen:", fullScreenName);
      } else {
        console.error("Screen not found:", fullScreenName);
      }
      
      // Update the active tab (except for competition details which isn't a tab)
      if (screenName !== 'competition-details-screen') {
        // Get base screen name without -screen suffix
        const baseScreenName = screenName.replace('-screen', '');
        
        // If this is an individual or business screen, remember it for back button purposes
        if (baseScreenName === 'individual' || baseScreenName === 'business') {
          localStorage.setItem('lastCompetitionScreen', baseScreenName);
        }
        
        document.querySelectorAll('.tab').forEach(tab => {
          if (tab.getAttribute('data-screen') === baseScreenName) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });
      }
      
      // Special handling for profile screen
      if (screenName === 'profile-screen' || screenName === 'profile') {
        updateProfileView();
      }
      
      // Special handling for analytics screen
      if (screenName === 'analytics-screen' || screenName === 'analytics') {
        console.log('Initializing analytics dashboard on screen change');
        setTimeout(() => {
          initializeAnalytics();
        }, 100);
      }
      
      console.log('Showing screen:', screenName);
    }
    
    // This is a legacy function, replaced by the one below
    // function showCompetitionDetails(competitionId) { ... }
    
    // Auth tab functionality
    function showAuthTab(tabName) {
      document.querySelectorAll('.auth-option').forEach(tab => {
        if (tab.textContent.toLowerCase() === tabName) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      document.getElementById(tabName + '-tab').classList.add('active');
    }
    
    // Login function
    function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      if (!email || !password) {
        showNotification('Please fill in all fields', 'error');
        return;
      }
      
      // Check password minimum length requirement
      if (password.length < 6) {
        showNotification('Password must be at least 6 characters long', 'error');
        return;
      }
      
      // Show loading state
      const loginButton = document.querySelector('#login-form button');
      const originalButtonText = loginButton.textContent;
      loginButton.textContent = 'Logging in...';
      loginButton.disabled = true;
      
      // Check if this is an admin account
      if (email.includes('admin')) {
        showNotification('Admin accounts should log in through the admin portal', 'error');
        loginButton.textContent = originalButtonText;
        loginButton.disabled = false;
        
        // Optionally, redirect to admin login page after a delay
        setTimeout(() => {
          window.location.href = '/admin';
        }, 2000);
        
        return;
      }
      
      // Call our API for regular users
      fetch('/api/auth/signin', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, password })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Login failed');
        }
        return response.json();
      })
      .then(data => {
        console.log('Login successful', data);
        isLoggedIn = true;
        
        // Extract user data
        let userName = 'User';
        if (data.user && data.user.user_metadata && data.user.user_metadata.full_name) {
          userName = data.user.user_metadata.full_name;
        }
        
        // Get user role (for regular or business users only)
        const isBusiness = email.includes('business') || email === 'demo@example.com';
        const userRole = isBusiness ? 'business' : 'user';
        
        currentUser = {
          name: userName,
          email: email,
          memberSince: 'March 2025',
          submissions: 5,
          awards: 2,
          votesCast: 12,
          role: userRole
        };
        
        // Save session to localStorage
        localStorage.setItem('user', JSON.stringify(currentUser));
        
        showNotification('Login successful!');
        updateProfileView();
        
        // Navigate to profile screen after successful login
        showScreen('profile');
      })
      .catch(error => {
        console.error('Error during login:', error);
        showNotification('Login failed: ' + error.message, 'error');
      })
      .finally(() => {
        // Reset button state
        loginButton.textContent = originalButtonText;
        loginButton.disabled = false;
      });
    }
    
    // Google Authentication function
    function loginWithGoogle() {
      showNotification('Preparing Google authentication...', 'info');
      
      // In a real implementation, we would initialize the Google Sign-In API
      // and get an ID token to send to our backend.
      // For this demo, we'll simulate the process.
      
      // Simulating a brief delay to represent the OAuth flow
      setTimeout(() => {
        // Create a mock Google token
        const mockGoogleToken = 'google-mock-token-' + Date.now();
        
        // Show loading state
        const googleButton = document.querySelector('button[onclick="loginWithGoogle()"]');
        const originalButtonText = googleButton.innerHTML;
        googleButton.innerHTML = '<span style="display: inline-block; width: 16px; height: 16px; border: 2px solid #ccc; border-radius: 50%; border-top-color: #333; animation: spin 1s linear infinite;"></span> Authenticating...';
        googleButton.disabled = true;
        
        // Add animation style if not already present
        if (!document.getElementById('spin-animation')) {
          const styleEl = document.createElement('style');
          styleEl.id = 'spin-animation';
          styleEl.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
          document.head.appendChild(styleEl);
        }
        
        // Call our API to verify the Google token
        fetch('/api/auth/google', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ token: mockGoogleToken })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Google authentication failed');
          }
          return response.json();
        })
        .then(data => {
          console.log('Google auth successful', data);
          isLoggedIn = true;
          
          // Extract user data
          let userName = 'Google User';
          if (data.user && data.user.user_metadata && data.user.user_metadata.full_name) {
            userName = data.user.user_metadata.full_name;
          }
          
          // Get email from user data
          let email = 'google-user@example.com';
          if (data.user && data.user.email) {
            email = data.user.email;
          }
          
          // Determine user role, default to regular user
          const userRole = 'user';
          
          currentUser = {
            name: userName,
            email: email,
            memberSince: 'March 2025',
            submissions: 0,
            awards: 0,
            votesCast: 0,
            role: userRole,
            provider: 'google'
          };
          
          // Save session to localStorage
          localStorage.setItem('user', JSON.stringify(currentUser));
          
          showNotification('Successfully signed in with Google!');
          updateProfileView();
          
          // Navigate to profile screen after successful login
          showScreen('profile');
        })
        .catch(error => {
          console.error('Error during Google auth:', error);
          showNotification('Google authentication failed: ' + error.message, 'error');
        })
        .finally(() => {
          // Reset button state
          googleButton.innerHTML = originalButtonText;
          googleButton.disabled = false;
        });
      }, 1000);
    }
    
    // Register function
    function register() {
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      
      if (!name || !email || !password) {
        showNotification('Please fill in all fields', 'error');
        return;
      }
      
      // Check password minimum length requirement
      if (password.length < 6) {
        showNotification('Password must be at least 6 characters long', 'error');
        return;
      }
      
      // Check if trying to register an admin account
      if (email.includes('admin')) {
        showNotification('Admin accounts can only be created through the admin portal', 'error');
        setTimeout(() => {
          window.location.href = '/admin';
        }, 2000);
        return;
      }
      
      // Show loading state
      const registerButton = document.querySelector('#register-form button');
      const originalButtonText = registerButton.textContent;
      registerButton.textContent = 'Registering...';
      registerButton.disabled = true;
      
      // Call our API
      fetch('/api/auth/signup', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
          name, 
          email, 
          password 
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Registration failed');
        }
        return response.json();
      })
      .then(data => {
        console.log('Registration successful', data);
        isLoggedIn = true;
        
        // Determine user role based on email (for demo purposes)
        const isAdmin = email.includes('admin');
        const isBusiness = email.includes('business') || email === 'demo@example.com';
        const userRole = isAdmin ? 'admin' : (isBusiness ? 'business' : 'user');
        
        currentUser = {
          name: name,
          email: email,
          memberSince: 'March 2025',
          submissions: 0,
          awards: 0,
          votesCast: 0,
          role: userRole
        };
        
        // Save session to localStorage
        localStorage.setItem('user', JSON.stringify(currentUser));
        
        showNotification('Registration successful!');
        updateProfileView();
        
        // Navigate to profile screen after successful registration
        showScreen('profile');
      })
      .catch(error => {
        console.error('Error during registration:', error);
        showNotification('Registration failed: ' + error.message, 'error');
      })
      .finally(() => {
        // Reset button state
        registerButton.textContent = originalButtonText;
        registerButton.disabled = false;
      });
    }
    
    // Logout function
    function logout() {
      isLoggedIn = false;
      currentUser = null;
      updateProfileView();
      showNotification('Logged out successfully');
    }
    
    // Update profile view based on auth state
    function updateProfileView() {
      if (isLoggedIn) {
        document.getElementById('profile-logged-out').style.display = 'none';
        document.getElementById('profile-logged-in').style.display = 'block';
        
        // Update profile display data
        if (currentUser) {
          // Update profile details
          const profileNameEl = document.getElementById('profile-user-name');
          const profileMemberSinceEl = document.getElementById('profile-member-since');
          const profileRoleEl = document.getElementById('profile-user-role');
          const profileSubmissionsEl = document.getElementById('profile-submissions');
          const profileAwardsEl = document.getElementById('profile-awards');
          const profileVotesEl = document.getElementById('profile-votes');
          
          if (profileNameEl) profileNameEl.textContent = currentUser.name || 'User';
          if (profileMemberSinceEl) profileMemberSinceEl.textContent = `Member since ${currentUser.memberSince || 'March 2025'}`;
          if (profileRoleEl) {
            // Format role name nicely
            let roleDisplay = 'Regular User';
            if (currentUser.role === 'admin') roleDisplay = 'Administrator';
            if (currentUser.role === 'business') roleDisplay = 'Business Account';
            
            profileRoleEl.textContent = roleDisplay;
          }
          
          if (profileSubmissionsEl) profileSubmissionsEl.textContent = currentUser.submissions || 0;
          if (profileAwardsEl) profileAwardsEl.textContent = currentUser.awards || 0;
          if (profileVotesEl) profileVotesEl.textContent = currentUser.votesCast || 0;
          
          // Set profile avatar initials
          const avatarEl = document.querySelector('.profile-avatar');
          if (avatarEl && currentUser.name) {
            // Extract initials from name
            const nameParts = currentUser.name.split(' ');
            let initials = nameParts[0][0]; // First letter of first name
            if (nameParts.length > 1) {
              initials += nameParts[nameParts.length - 1][0]; // First letter of last name
            }
            avatarEl.textContent = initials.toUpperCase();
          }
        }
        
        // Show or hide back office based on user role
        const backOfficeSection = document.getElementById('back-office-section');
        if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'business')) {
          backOfficeSection.style.display = 'block';
          console.log('Showing back office for user role:', currentUser.role);
        } else {
          backOfficeSection.style.display = 'none';
          console.log('Hiding back office for regular user');
        }
      } else {
        document.getElementById('profile-logged-out').style.display = 'block';
        document.getElementById('profile-logged-in').style.display = 'none';
        
        // Hide back office when logged out
        const backOfficeSection = document.getElementById('back-office-section');
        if (backOfficeSection) {
          backOfficeSection.style.display = 'none';
        }
      }
    }
    
    // Show category suggestion modal
    function showCategorySuggestionModal() {
      document.getElementById('category-suggestion-modal').style.display = 'flex';
    }
    
    // Close category suggestion modal
    function closeCategorySuggestionModal() {
      document.getElementById('category-suggestion-modal').style.display = 'none';
    }
    
    // Submit category suggestion
    function submitCategorySuggestion() {
      const categoryName = document.getElementById('category-name').value;
      const description = document.getElementById('category-description').value;
      
      if (!categoryName || !description) {
        showNotification('Please fill in all fields', 'error');
        return;
      }
      
      // Show loading state
      const submitButton = document.querySelector('#category-form button');
      const originalButtonText = submitButton.textContent;
      submitButton.textContent = 'Submitting...';
      submitButton.disabled = true;
      
      // Call our API
      fetch('/api/category/suggest', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: categoryName,
          description: description
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to submit category suggestion');
        }
        return response.json();
      })
      .then(data => {
        console.log('Category suggestion submitted:', data);
        showNotification('Category suggestion submitted successfully!');
        closeCategorySuggestionModal();
        
        // Reset form
        document.getElementById('category-name').value = '';
        document.getElementById('category-description').value = '';
      })
      .catch(error => {
        console.error('Error submitting category:', error);
        showNotification('Failed to submit category: ' + error.message, 'error');
      })
      .finally(() => {
        // Reset button state
        submitButton.textContent = originalButtonText;
        submitButton.disabled = false;
      });
    }
    
    // Submit entry
    function submitEntry() {
      const competitionId = document.getElementById('competition-select').value;
      const title = document.getElementById('submission-title').value;
      const description = document.getElementById('submission-description').value;
      const file = document.getElementById('submission-file').files[0];
      
      if (!competitionId || !title || !description) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }
      
      if (!isLoggedIn) {
        showNotification('Please log in to submit your entry', 'error');
        showScreen('profile');
        return;
      }
      
      // Show loading state
      const submitButton = document.querySelector('#submission-form button');
      const originalButtonText = submitButton.textContent;
      submitButton.textContent = 'Submitting...';
      submitButton.disabled = true;
      
      // Create submission data object
      const submissionData = {
        competitionId: competitionId,
        title: title,
        description: description,
        userId: currentUser?.id || 'anonymous',
        timestamp: new Date().toISOString()
      };
      
      // Check if we're online
      if (navigator.onLine) {
        // We're online - send submission to API
        sendSubmissionToServer(submissionData, file, submitButton, originalButtonText);
      } else {
        // We're offline - save submission for later sync
        saveSubmissionForOfflineSync(submissionData, file, submitButton, originalButtonText);
      }
    }
    
    // Function to send submission to server
    function sendSubmissionToServer(submissionData, file, submitButton, originalButtonText) {
      fetch('/api/submission', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(submissionData)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to submit entry');
        }
        return response.json();
      })
      .then(data => {
        console.log('Entry submitted successfully:', data);
        showNotification('Entry submitted successfully!');
        
        // Reset form
        resetSubmissionForm();
      })
      .catch(error => {
        console.error('Error submitting entry:', error);
        
        // If there's a network error, save for offline sync
        if (!navigator.onLine || error.message.includes('network')) {
          saveSubmissionForOfflineSync(submissionData, file, submitButton, originalButtonText);
        } else {
          showNotification('Failed to submit entry: ' + error.message, 'error');
          
          // Reset button state
          submitButton.textContent = originalButtonText;
          submitButton.disabled = false;
        }
      });
    }
    
    // Function to save submission for offline sync
    async function saveSubmissionForOfflineSync(submissionData, file, submitButton, originalButtonText) {
      try {
        // Save to IndexedDB
        await window.dbHelper.saveSubmissionForSync(submissionData, file);
        
        // Register for background sync
        const syncRegistered = await window.dbHelper.registerBackgroundSync('sync-submissions');
        
        console.log('Submission saved for background sync, registration success:', syncRegistered);
        showNotification('You\'re offline. Your submission will be uploaded when you\'re back online.', 'info');
        
        // Reset form
        resetSubmissionForm();
      } catch (error) {
        console.error('Failed to save submission for offline sync:', error);
        showNotification('Failed to save your submission for later. Please try again when online.', 'error');
      } finally {
        // Reset button state
        submitButton.textContent = originalButtonText;
        submitButton.disabled = false;
      }
    }
    
    // Helper function to reset submission form
    function resetSubmissionForm() {
      document.getElementById('competition-select').value = '';
      document.getElementById('submission-title').value = '';
      document.getElementById('submission-description').value = '';
      document.getElementById('submission-file').value = '';
    }
    
    // Show notification
    function showNotification(message, type = 'success') {
      // Get or create notification container
      let container = document.getElementById('notification-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.style.position = 'fixed';
        container.style.bottom = '20px';
        container.style.right = '20px';
        container.style.zIndex = '1000';
        document.body.appendChild(container);
      }
      
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      // Create close button
      const closeBtn = document.createElement('span');
      closeBtn.innerHTML = '&times;';
      closeBtn.style.position = 'absolute';
      closeBtn.style.right = '10px';
      closeBtn.style.top = '10px';
      closeBtn.style.cursor = 'pointer';
      closeBtn.style.fontSize = '16px';
      closeBtn.style.opacity = '0.7';
      closeBtn.style.transition = 'opacity 0.2s';
      
      closeBtn.addEventListener('mouseover', () => {
        closeBtn.style.opacity = '1';
      });
      
      closeBtn.addEventListener('mouseout', () => {
        closeBtn.style.opacity = '0.7';
      });
      
      closeBtn.addEventListener('click', () => {
        // Add slide-out animation before removing
        notification.style.animation = 'slide-out 0.3s forwards';
        setTimeout(() => {
          if (container.contains(notification)) {
            container.removeChild(notification);
          }
        }, 300);
      });
      
      // Create icon based on type
      let icon = '';
      switch(type) {
        case 'success':
          icon = '✓';
          break;
        case 'error':
          icon = '✗';
          break;
        case 'info':
          icon = 'ℹ';
          break;
        case 'warning':
          icon = '⚠';
          break;
        default:
          icon = '✓';
      }
      
      const iconSpan = document.createElement('span');
      iconSpan.textContent = icon;
      iconSpan.style.marginRight = '10px';
      iconSpan.style.fontWeight = 'bold';
      
      // Create message span
      const messageSpan = document.createElement('span');
      messageSpan.textContent = message;
      
      // Assemble notification
      notification.appendChild(iconSpan);
      notification.appendChild(messageSpan);
      notification.appendChild(closeBtn);
      
      // Add to container
      container.appendChild(notification);
      
      // Show notification
      setTimeout(() => {
        notification.style.display = 'block';
      }, 100);
      
      // Increment notification count for badge if relevant
      if (['success', 'info', 'warning'].includes(type) && type !== 'error') {
        if (typeof updateAppBadge === 'function') {
          updateAppBadge(1);
        }
      }
      
      // Auto-hide after a delay
      setTimeout(() => {
        // Only remove if it hasn't been manually closed
        if (container.contains(notification)) {
          notification.style.animation = 'slide-out 0.3s forwards';
          setTimeout(() => {
            if (container.contains(notification)) {
              container.removeChild(notification);
            }
          }, 300);
        }
      }, 5000);
    }
    
    // Social sharing function
    function shareContent(platform, title, text, url) {
      // If Web Share API is available and the platform is 'native'
      if (navigator.share && platform === 'native') {
        navigator.share({
          title: title,
          text: text,
          url: url || window.location.href
        })
        .then(() => {
          console.log('Successfully shared');
          showNotification('Successfully shared!');
        })
        .catch((error) => {
          console.error('Error sharing:', error);
          showNotification('Could not share content', 'error');
          // Fallback to copy to clipboard
          copyToClipboard(url || window.location.href);
        });
        return;
      }
      
      // Platform specific sharing
      let shareUrl;
      
      switch(platform) {
        case 'twitter':
          shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url || window.location.href)}`;
          break;
        case 'facebook':
          shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url || window.location.href)}`;
          break;
        case 'linkedin':
          shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url || window.location.href)}`;
          break;
        case 'email':
          shareUrl = `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(text + '\n\n' + (url || window.location.href))}`;
          break;
        case 'clipboard':
          copyToClipboard(url || window.location.href);
          return;
        default:
          showNotification('Sharing not available for this platform', 'error');
          return;
      }
      
      // Open a popup window for sharing (except for email)
      if (platform !== 'email') {
        window.open(shareUrl, '_blank', 'width=600,height=400');
      } else {
        window.location.href = shareUrl;
      }
      
      showNotification('Content shared successfully!');
    }
    
    // Helper function to copy URL to clipboard
    function copyToClipboard(text) {
      // Create temporary input
      const input = document.createElement('input');
      input.style.position = 'fixed';
      input.style.opacity = 0;
      input.value = text;
      document.body.appendChild(input);
      input.select();
      
      // Copy and clean up
      try {
        document.execCommand('copy');
        showNotification('Link copied to clipboard!');
      } catch (err) {
        console.error('Could not copy text: ', err);
        showNotification('Failed to copy link', 'error');
      }
      
      document.body.removeChild(input);
    }
    
    // Show competition details
    function showCompetitionDetails(competitionId) {
      console.log('Showing details for competition:', competitionId);
      
      try {
        // Show loading message
        document.querySelectorAll('.screen').forEach(screen => {
          screen.style.display = 'none';
        });
        
        const detailsScreen = document.getElementById('competition-details-screen');
        detailsScreen.style.display = 'block';
        detailsScreen.innerHTML = '<div class="container"><div class="card">Loading competition details...</div></div>';
        
        // Update header to show a back button
        // Get the last screen the user was on (either individual or business)
        const lastScreen = localStorage.getItem('lastCompetitionScreen') || 'individual';
        document.getElementById('main-header').innerHTML = `
          <button class="back-button" onclick="showScreen('${lastScreen}')">
            <span class="back-icon">←</span> Back
          </button>
          <h1>Competition Details</h1>
        `;
        
        // Get the competition details from our API
        fetch(`/api/competitions/${competitionId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch competition details');
            }
            return response.json();
          })
          .then(competition => {
            // Format deadline date if available
            let deadline = 'Coming soon';
            if (competition.deadline) {
              try {
                const deadlineDate = new Date(competition.deadline);
                deadline = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
              } catch (e) {
                console.error('Error formatting date:', e);
                deadline = competition.deadline;
              }
            }
            
            // Create competition details HTML
            detailsScreen.innerHTML = `
              <div class="container">
                <div class="card">
                  <div class="competition-header">
                    <h2 id="competition-title">${competition.title}</h2>
                    <div class="competition-meta">
                      <div class="meta-item"><strong>Deadline:</strong> <span id="competition-deadline">${deadline}</span></div>
                      <div class="meta-item"><strong>Entries:</strong> <span id="competition-entries">0</span></div>
                    </div>
                    <div id="competition-categories">
                      <span class="badge primary">${competition.category || 'General'}</span>
                    </div>
                  </div>
                  
                  <div id="competition-description">
                    <p>${competition.description}</p>
                  </div>
                  
                  <h3>Prizes</h3>
                  <ul id="competition-prizes">
                    <li>${competition.prize || 'Prizes to be announced'}</li>
                  </ul>
                  
                  <h3>Rules</h3>
                  <ul id="competition-rules">
                    <li>All submissions must be original work</li>
                    <li>One submission per participant</li>
                  </ul>
                  
                  <h3>Share This Competition</h3>
                  <div class="share-buttons">
                    <button class="share-button twitter" title="Share on Twitter" onclick="shareContent('twitter', '${competition.title}', 'Check out this creative competition: ${competition.title}')">
                      T
                    </button>
                    <button class="share-button facebook" title="Share on Facebook" onclick="shareContent('facebook', '${competition.title}', 'Join this creative competition')">
                      f
                    </button>
                    <button class="share-button linkedin" title="Share on LinkedIn" onclick="shareContent('linkedin', '${competition.title}', 'Participate in ${competition.title}')">
                      in
                    </button>
                    <button class="share-button email" title="Share via Email" onclick="shareContent('email', '${competition.title}', 'I thought you might be interested in this competition: ${competition.title}')">
                      ✉
                    </button>
                    <button class="share-button clipboard" title="Copy Link" onclick="shareContent('clipboard', '${competition.title}', 'Check out this competition')">
                      📋
                    </button>
                  </div>
                  
                  <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="showScreen('submit'); document.getElementById('competition-select').value = '${competition.id}';">Submit Entry</button>
                    <button onclick="showScreen(localStorage.getItem('lastCompetitionScreen') || 'individual')" class="secondary">Back to List</button>
                  </div>
                </div>
                
                <div class="card">
                  <h3>Top Submissions</h3>
                  <div id="submissions-list">
                    <p class="loading">Loading submissions...</p>
                  </div>
                </div>
              </div>
            `;
            
            // Load submissions for this competition
            loadCompetitionSubmissions(competitionId);
          })
          .catch(error => {
            console.error('Error loading competition details:', error);
            detailsScreen.innerHTML = `
              <div class="container">
                <div class="card">
                  <h2>Error</h2>
                  <p>Error loading competition details: ${error.message}</p>
                  <button onclick="showScreen(localStorage.getItem('lastCompetitionScreen') || 'individual')" class="secondary">Back to Competitions</button>
                </div>
              </div>
            `;
          });
      } catch (error) {
        console.error('Error in showCompetitionDetails function:', error);
        showNotification('An unexpected error occurred', 'error');
        
        // Get the last screen the user was on (either individual or business)
        const lastScreen = localStorage.getItem('lastCompetitionScreen') || 'individual';
        showScreen(lastScreen);
      }
    }
    
    // Load competitions from API
    // Load competition submissions and enable voting
    function loadCompetitionSubmissions(competitionId) {
      console.log('Loading submissions for competition:', competitionId);
      const submissionsList = document.getElementById('submissions-list');
      
      if (!submissionsList) {
        console.error('Submissions list element not found');
        return;
      }
      
      submissionsList.innerHTML = '<p class="loading">Loading submissions...</p>';
      
      fetch(`/api/competitions/${competitionId}/submissions`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch submissions');
          }
          return response.json();
        })
        .then(submissions => {
          console.log('Submissions loaded:', submissions);
          
          if (!submissions || submissions.length === 0) {
            submissionsList.innerHTML = '<p>No submissions yet. Be the first to enter!</p>';
            return;
          }
          
          // Clear loading message
          submissionsList.innerHTML = '';
          
          // Sort submissions by votes (highest first)
          submissions.sort((a, b) => (b.votes || 0) - (a.votes || 0));
          
          // Add each submission with voting button
          submissions.forEach(submission => {
            const submissionElement = document.createElement('div');
            submissionElement.className = 'submission-item';
            
            // Format creation date if available
            let createdDate = 'Recently';
            if (submission.created_at) {
              try {
                const date = new Date(submission.created_at);
                createdDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
              } catch (e) {
                console.error('Error formatting submission date:', e);
              }
            }
            
            submissionElement.innerHTML = `
              <div class="submission-header">
                <h4>${submission.title}</h4>
                <span class="submission-date">Submitted: ${createdDate}</span>
              </div>
              <p>${submission.description}</p>
              <div class="submission-footer">
                <div class="votes-container">
                  <span class="votes-count" id="votes-${submission.id}">${submission.votes || 0}</span>
                  <span class="votes-label">votes</span>
                </div>
                <button class="vote-button" onclick="voteForSubmission('${submission.id}')">
                  <span class="vote-icon">👍</span> Vote
                </button>
              </div>
            `;
            
            submissionsList.appendChild(submissionElement);
          });
        })
        .catch(error => {
          console.error('Error loading submissions:', error);
          submissionsList.innerHTML = `<p>Error loading submissions: ${error.message}</p>`;
        });
    }
    
    // Vote for a submission
    function voteForSubmission(submissionId) {
      console.log('Voting for submission:', submissionId);
      
      // Disable all vote buttons to prevent multiple votes
      const voteButtons = document.querySelectorAll('.vote-button');
      voteButtons.forEach(button => {
        button.disabled = true;
        button.classList.add('disabled');
      });
      
      // Check if we're online
      if (navigator.onLine) {
        // We're online - send vote to API
        sendVoteToServer(submissionId);
      } else {
        // We're offline - save vote for later sync
        saveVoteForOfflineSync(submissionId);
      }
    }
    
    // Function to send vote to server
    function sendVoteToServer(submissionId) {
      fetch('/api/vote', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ submissionId })
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to record vote');
          }
          return response.json();
        })
        .then(data => {
          console.log('Vote recorded successfully:', data);
          updateVoteUI(submissionId, data.votes);
        })
        .catch(error => {
          console.error('Error recording vote:', error);
          // If there's a network error, save for offline sync
          if (!navigator.onLine || error.message.includes('network')) {
            saveVoteForOfflineSync(submissionId);
          } else {
            showNotification('Failed to record vote: ' + error.message, 'error');
          }
        });
    }
    
    // Function to save vote for offline sync
    async function saveVoteForOfflineSync(submissionId) {
      try {
        // Create vote object
        const vote = { 
          submissionId: submissionId,
          timestamp: new Date().toISOString()
        };
        
        // Save to IndexedDB
        await window.dbHelper.saveVoteForSync(vote);
        
        // Register for background sync
        const syncRegistered = await window.dbHelper.registerBackgroundSync('sync-votes');
        
        // Update UI with optimistic update
        updateVoteUI(submissionId, null, true);
        
        // Show notification
        showNotification('You\'re offline. Your vote will be submitted when you\'re back online.', 'info');
        console.log('Vote saved for background sync, registration success:', syncRegistered);
      } catch (error) {
        console.error('Failed to save vote for offline sync:', error);
        showNotification('Failed to save your vote for later. Please try again when online.', 'error');
      }
    }
    
    // Update vote UI after voting
    function updateVoteUI(submissionId, votes, isOffline = false) {
      const votesElement = document.getElementById(`votes-${submissionId}`);
      if (votesElement) {
        if (votes !== null) {
          // If we have votes count from the server
          votesElement.textContent = votes;
        } else if (isOffline) {
          // If offline, increment locally by 1
          const currentVotes = parseInt(votesElement.textContent || '0', 10);
          votesElement.textContent = currentVotes + 1;
        }
        
        // Add animation class for visual feedback
        votesElement.classList.add('vote-added');
        setTimeout(() => {
          votesElement.classList.remove('vote-added');
        }, 1000);
      }
      
      // Show success notification
      showNotification('Your vote has been recorded!', 'success');
      
      // Re-enable the vote buttons after a delay
      setTimeout(() => {
        const voteButtons = document.querySelectorAll('.vote-button');
        voteButtons.forEach(button => {
          button.disabled = false;
          button.classList.remove('disabled');
        });
      }, 1000);
    }
    
    function loadCompetitions() {
      // Load both individual and business competitions
      loadIndividualCompetitions();
      loadBusinessCompetitions();
      
      // Update competition select dropdown for the submission form
      updateCompetitionDropdown();
    }
    
    function loadIndividualCompetitions() {
      const competitionsList = document.getElementById('individual-competitions-list');
      const loadingHTML = '<div class="card"><p>Loading individual competitions...</p></div>';
      competitionsList.innerHTML = loadingHTML;
      
      fetch('/api/competitions')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch competitions');
          }
          return response.json();
        })
        .then(competitions => {
          console.log('All competitions loaded:', competitions);
          
          // Filter for individual competitions (those without a business_id or with empty business_id)
          const individualCompetitions = competitions.filter(comp => 
            !comp.business_id || comp.business_id === '');
          
          console.log('Individual competitions:', individualCompetitions);
          
          if (individualCompetitions && individualCompetitions.length > 0) {
            // Clear loading message
            competitionsList.innerHTML = '';
            
            // Add each competition
            individualCompetitions.forEach(competition => {
              // Create competition card
              const card = document.createElement('div');
              card.className = 'card';
              
              // Format deadline date if available
              let deadline = 'Coming soon';
              if (competition.deadline) {
                try {
                  const deadlineDate = new Date(competition.deadline);
                  deadline = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                } catch (e) {
                  console.error('Error formatting date:', e);
                  deadline = competition.deadline;
                }
              }
              
              // Set HTML content for the card
              card.innerHTML = `
                <h3>${competition.title}</h3>
                <div class="competition-meta">
                  <div class="meta-item"><strong>Ends:</strong> ${deadline}</div>
                  <div class="meta-item"><strong>Prize:</strong> ${competition.prize || 'Various prizes'}</div>
                </div>
                <p>${competition.description}</p>
                <div>
                  <span class="badge primary">${competition.category || 'General'}</span>
                  <span class="badge success">${competition.status || 'Active'}</span>
                  <span class="badge info">Individual</span>
                </div>
                <div style="margin-top: 15px;">
                  <button onclick="showCompetitionDetails('${competition.id}')">View Details</button>
                </div>
              `;
              
              competitionsList.appendChild(card);
            });
          } else {
            competitionsList.innerHTML = '<div class="card"><p>No individual competitions found. Check back soon!</p></div>';
          }
        })
        .catch(error => {
          console.error('Error loading individual competitions:', error);
          competitionsList.innerHTML = `<div class="card"><p>Error loading competitions: ${error.message}</p></div>`;
        });
    }
    
    function loadBusinessCompetitions() {
      const competitionsList = document.getElementById('business-competitions-list');
      const loadingHTML = '<div class="card"><p>Loading business competitions...</p></div>';
      competitionsList.innerHTML = loadingHTML;
      
      fetch('/api/competitions')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch competitions');
          }
          return response.json();
        })
        .then(competitions => {
          // Filter for business competitions (those with a business_id)
          const businessCompetitions = competitions.filter(comp => 
            comp.business_id && comp.business_id !== '');
          
          console.log('Business competitions:', businessCompetitions);
          
          if (businessCompetitions && businessCompetitions.length > 0) {
            // Clear loading message
            competitionsList.innerHTML = '';
            
            // Add each competition
            businessCompetitions.forEach(competition => {
              // Create competition card
              const card = document.createElement('div');
              card.className = 'card';
              
              // Format deadline date if available
              let deadline = 'Coming soon';
              if (competition.deadline) {
                try {
                  const deadlineDate = new Date(competition.deadline);
                  deadline = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                } catch (e) {
                  console.error('Error formatting date:', e);
                  deadline = competition.deadline;
                }
              }
              
              // Set HTML content for the card
              card.innerHTML = `
                <h3>${competition.title}</h3>
                <div class="competition-meta">
                  <div class="meta-item"><strong>Ends:</strong> ${deadline}</div>
                  <div class="meta-item"><strong>Prize:</strong> ${competition.prize || 'TBD'}</div>
                </div>
                <p>${competition.description}</p>
                <div>
                  <span class="badge primary">${competition.category || 'General'}</span>
                  <span class="badge success">${competition.status || 'Active'}</span>
                  <span class="badge warning">Business</span>
                </div>
                <div style="margin-top: 15px;">
                  <button onclick="showCompetitionDetails('${competition.id}')">View Details</button>
                </div>
              `;
              
              competitionsList.appendChild(card);
            });
          } else {
            competitionsList.innerHTML = '<div class="card"><p>No business competitions found. Check back soon!</p></div>';
          }
        })
        .catch(error => {
          console.error('Error loading business competitions:', error);
          competitionsList.innerHTML = `<div class="card"><p>Error loading competitions: ${error.message}</p></div>`;
        });
    }
    
    function updateCompetitionDropdown() {
      // Update competition select dropdown for the submission form
      fetch('/api/competitions')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch competitions');
          }
          return response.json();
        })
        .then(competitions => {
          const competitionSelect = document.getElementById('competition-select');
          competitionSelect.innerHTML = '<option value="">-- Select a competition --</option>';
          
          if (competitions && competitions.length > 0) {
            // Add each competition to the dropdown
            competitions.forEach(competition => {
              const option = document.createElement('option');
              option.value = competition.id;
              
              // Add a prefix to distinguish between individual and business competitions
              const prefix = competition.business_id ? '[Business] ' : '[Individual] ';
              option.textContent = prefix + competition.title;
              
              competitionSelect.appendChild(option);
            });
          }
        })
        .catch(error => {
          console.error('Error updating competition dropdown:', error);
        });
    }
    
    // Log when page loads
    // Function to parse URL query parameters
    function getUrlParameters() {
      const params = {};
      const queryString = window.location.search.substring(1);
      const pairs = queryString.split('&');
      
      for (let i = 0; i < pairs.length; i++) {
        if (!pairs[i]) continue;
        const pair = pairs[i].split('=');
        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
      }
      
      return params;
    }
    
    window.addEventListener('load', function() {
      console.log('CreativeCrowdChallenge app loaded successfully!');
      
      // Parse URL query parameters
      const urlParams = getUrlParameters();
      const isAdminAnalytics = urlParams.adminAnalytics === 'true';
      const isAnalyticsDemo = urlParams.analyticsDemo === 'true';
      
      // Store admin access state
      window.hasAnalyticsAccess = isAdminAnalytics || isAnalyticsDemo;
      
      // Load competitions on page load
      loadCompetitions();
      
      // Check for existing logged in user
      const savedUser = localStorage.getItem('user');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          isLoggedIn = true;
          updateProfileView();
        } catch (e) {
          console.error('Error loading saved user:', e);
          localStorage.removeItem('user');
        }
      }
      
      // If this is an admin analytics view, automatically show the analytics tab
      if (isAdminAnalytics || isAnalyticsDemo) {
        // Select analytics tab and show analytics screen
        const analyticsTab = document.querySelector('.tab[data-screen="analytics"]');
        if (analyticsTab) {
          analyticsTab.click();
        }
      }
      
      // Initialize analytics if user visits that tab
      const analyticsTab = document.querySelector('.tab[data-screen="analytics"]');
      if (analyticsTab) {
        analyticsTab.addEventListener('click', function() {
          initializeAnalytics();
          
          // Add a little delay to ensure the screen is fully shown before rendering charts
          setTimeout(() => {
            loadBusinessAnalytics();
          }, 100);
        });
      }
    });
    
    // Business Analytics Functions
    let competitionsChart;
    let demographicsChart;
    let timelineChart;
    let engagementChart;
    let sourcesChart;
    let deviceChart;
    let analyticsData = null;
    
    // Helper function to reset canvas for chart reuse
    function resetCanvasElement(canvasId) {
      // First check if this is already a canvas element
      let canvas = document.getElementById(canvasId);
      if (canvas && canvas.tagName === 'CANVAS') {
        // It's already a canvas, just clear any existing Chart instance
        console.log(`Found existing canvas element: ${canvasId}`);
        return canvas;
      }
      
      // Otherwise, look for a container and create a canvas inside it
      const container = document.getElementById(canvasId.replace('-canvas', ''));
      if (container) {
        // Clear the container completely
        container.innerHTML = '';
        
        // Create a fresh canvas element
        canvas = document.createElement('canvas');
        canvas.id = canvasId; // Use the exact ID that was requested
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        container.appendChild(canvas);
        
        console.log(`Created new canvas in container: ${container.id}`);
        return canvas;
      }
      
      // If we get here, we couldn't find either the canvas or a suitable container
      console.error(`Neither canvas nor container found for: ${canvasId}`);
      console.log('Available elements:', 
        Array.from(document.querySelectorAll('.chart-container'))
          .map(el => el.id || 'unnamed-container')
      );
      return null;
    }
    
    function initializeAnalytics() {
      console.log('Initializing analytics dashboard');
      
      // Set up event listeners for business selector and export buttons
      const businessSelector = document.getElementById('business-selector');
      if (businessSelector) {
        businessSelector.addEventListener('change', loadBusinessAnalytics);
        // Load initial data after a short delay to ensure DOM is fully ready
        setTimeout(() => {
          // Load default business analytics
          loadBusinessAnalytics();
        }, 100);
      }
      
      // Connect export buttons
      const exportButtons = document.querySelectorAll('.export-button');
      exportButtons.forEach(button => {
        button.addEventListener('click', function() {
          const format = this.getAttribute('data-format');
          exportAnalytics(format);
        });
      });
      
      // Initialize analytics request form
      initializeAnalyticsRequestForm();
      
      // Load user's existing analytics requests
      loadUserAnalyticsRequests();
    }
    
    // Initialize the analytics request form with the user's competitions
    function initializeAnalyticsRequestForm() {
      console.log('Initializing analytics request form');
      const competitionSelector = document.getElementById('competition-selector');
      
      if (!competitionSelector) {
        console.error('Competition selector not found');
        return;
      }
      
      // Clear existing options (keeping the default)
      while (competitionSelector.options.length > 1) {
        competitionSelector.remove(1);
      }
      
      // Get business competitions to populate the dropdown
      // We're filtering for business competitions that are visible to the current user
      const businessCompetitions = Object.values(competitions).filter(comp => 
        comp.type === 'business' && (currentUser?.role === 'business' || currentUser?.role === 'admin')
      );
      
      if (businessCompetitions.length === 0) {
        console.log('No business competitions found for this user');
        // Add a placeholder option
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No competitions available';
        option.disabled = true;
        competitionSelector.appendChild(option);
        
        // Show message to the user
        document.getElementById('competition-selector').disabled = true;
        document.getElementById('submit-request-btn').disabled = true;
        
        const requestStatus = document.getElementById('request-status');
        if (requestStatus) {
          requestStatus.textContent = 'You need business competitions to request analytics.';
          requestStatus.style.color = '#ef4444';
        }
        return;
      }
      
      // Add competitions to the dropdown
      businessCompetitions.forEach(comp => {
        const option = document.createElement('option');
        option.value = comp.id;
        option.textContent = comp.title;
        competitionSelector.appendChild(option);
      });
      
      // Enable the form elements
      document.getElementById('competition-selector').disabled = false;
      document.getElementById('submit-request-btn').disabled = false;
      document.getElementById('request-status').textContent = '';
    }
    
    // Load the user's existing analytics requests
    async function loadUserAnalyticsRequests() {
      console.log('Loading user analytics requests');
      
      if (!currentUser) {
        console.log('User not logged in');
        return;
      }
      
      const requestsContainer = document.getElementById('user-analytics-requests');
      const noRequestsMessage = document.getElementById('no-requests-message');
      
      if (!requestsContainer || !noRequestsMessage) {
        console.error('Analytics requests container elements not found');
        return;
      }
      
      // Show loading state
      requestsContainer.innerHTML = '<div class="loading-indicator">Loading your requests...</div>';
      
      try {
        // Call the API to get user's requests
        const response = await fetch('/api/analytics/requests', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-User-Id': currentUser.id || 'demo-user-id',
            'X-User-Role': currentUser.role || 'business'
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to load analytics requests');
        }
        
        const requests = await response.json();
        console.log('Loaded analytics requests:', requests);
        
        // Clear container
        requestsContainer.innerHTML = '';
        
        if (requests.length === 0) {
          // Show no requests message
          noRequestsMessage.style.display = 'block';
        } else {
          // Hide no requests message and display the requests
          noRequestsMessage.style.display = 'none';
          
          // Sort requests by creation date (newest first)
          requests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          
          // Render each request
          requests.forEach(request => {
            const requestElement = createRequestElement(request);
            requestsContainer.appendChild(requestElement);
          });
        }
      } catch (error) {
        console.error('Error loading analytics requests:', error);
        requestsContainer.innerHTML = `
          <div class="error-message">
            Failed to load your analytics requests. Please try again later.
          </div>
        `;
      }
    }
    
    // Create an element to display an analytics request
    function createRequestElement(request) {
      const requestItem = document.createElement('div');
      requestItem.className = 'request-item';
      requestItem.id = `request-${request.id}`;
      
      // Get competition title from the stored competitions
      let competitionTitle = 'Unknown Competition';
      if (request.competitionIds && request.competitionIds.length > 0) {
        const competition = competitions[request.competitionIds[0]];
        if (competition) {
          competitionTitle = competition.title;
        }
      }
      
      // Format the date
      const requestDate = new Date(request.createdAt);
      const formattedDate = requestDate.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
      
      // Set status class
      const statusClass = `status-${request.status.toLowerCase()}`;
      
      // Create the content HTML
      requestItem.innerHTML = `
        <div class="request-header">
          <span class="request-title">${competitionTitle}</span>
          <span class="request-date">${formattedDate}</span>
        </div>
        <div class="request-details">
          <p><strong>Time Period:</strong> ${request.timeFrame}</p>
          <p>${request.description}</p>
        </div>
        <div class="request-status-badge ${statusClass}">
          ${capitalizeFirstLetter(request.status)}
        </div>
        ${request.adminNotes ? `<div class="admin-notes"><strong>Admin Notes:</strong> ${request.adminNotes}</div>` : ''}
      `;
      
      return requestItem;
    }
    
    // Helper function to capitalize first letter
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    // Handle analytics request form submission
    async function submitAnalyticsRequest(event) {
      event.preventDefault();
      console.log('Submitting analytics request');
      
      if (!currentUser) {
        showNotification('Please log in to submit an analytics request', 'error');
        return;
      }
      
      const competitionId = document.getElementById('competition-selector').value;
      const timeFrame = document.getElementById('date-range').value;
      const description = document.getElementById('request-details').value;
      
      if (!competitionId || !timeFrame) {
        showNotification('Please complete all required fields', 'error');
        return;
      }
      
      // Show loading state
      const submitButton = document.getElementById('submit-request-btn');
      const requestStatus = document.getElementById('request-status');
      
      submitButton.disabled = true;
      submitButton.textContent = 'Submitting...';
      requestStatus.textContent = '';
      
      try {
        // Prepare request data
        const requestData = {
          businessId: 'mock-business-1', // In a real app, get this from the user's profile
          competitionIds: [competitionId],
          timeFrame,
          description,
          userId: currentUser.id || 'demo-user-id',
          userEmail: currentUser.email || 'demo@example.com',
          requestType: 'competition-analytics'
        };
        
        // Call the API to create the request
        const response = await fetch('/api/analytics/request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to submit analytics request');
        }
        
        const result = await response.json();
        console.log('Analytics request submitted:', result);
        
        // Show success message
        showNotification('Analytics request submitted successfully!');
        requestStatus.textContent = 'Request submitted successfully!';
        requestStatus.style.color = '#10b981';
        
        // Reset form
        document.getElementById('request-details').value = '';
        
        // Reload the user's requests
        loadUserAnalyticsRequests();
      } catch (error) {
        console.error('Error submitting analytics request:', error);
        showNotification('Failed to submit request: ' + error.message, 'error');
        
        requestStatus.textContent = 'Failed to submit request. Please try again.';
        requestStatus.style.color = '#ef4444';
      } finally {
        // Reset button state
        submitButton.disabled = false;
        submitButton.textContent = 'Submit Request';
      }
    }
    
    // Show Analytics Dashboard from back office
    function showAnalyticsDashboard() {
      console.log('Opening Analytics Dashboard from back office');
      showScreen('analytics-screen');
      
      // Add a back button in the header when coming from profile
      document.getElementById('main-header').innerHTML = `
        <button class="back-button" onclick="showScreen('profile')">
          <span class="back-icon">←</span> Back to Login
        </button>
        <h1>Analytics Dashboard</h1>
      `;
      
      // Initialize analytics dashboard
      setTimeout(() => {
        initializeAnalytics();
      }, 100);
    }
    
    function loadBusinessAnalytics() {
      // Check if user has analytics access
      if (!window.hasAnalyticsAccess && currentUser?.role !== 'admin') {
        console.log('Unauthorized access attempt to analytics dashboard');
        showRequestAnalyticsForm();
        return;
      }
      
      const businessId = document.getElementById('business-selector').value;
      const timelinePeriod = document.getElementById('timeline-period')?.value || '30days';
      
      // Clear existing charts if they exist
      if (competitionsChart) {
        competitionsChart.destroy();
        competitionsChart = null;
      }
      if (demographicsChart) {
        demographicsChart.destroy();
        demographicsChart = null;
      }
      if (timelineChart) {
        timelineChart.destroy();
        timelineChart = null;
      }
      if (engagementChart) {
        engagementChart.destroy();
        engagementChart = null;
      }
      if (sourcesChart) {
        sourcesChart.destroy();
        sourcesChart = null;
      }
      if (deviceChart) {
        deviceChart.destroy();
        deviceChart = null;
      }
      
      // Show loading state and prepare chart containers
      const chartContainers = [
        'competitions-chart',
        'demographics-chart',
        'timeline-chart',
        'engagement-chart',
        'sources-chart'
      ];
      
      // Reset all chart containers
      chartContainers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
          container.innerHTML = '<div class="loading">Loading chart data...</div>';
          // Add a canvas element that will be used for each chart
          if (containerId === 'engagement-chart') {
            const canvas = document.createElement('canvas');
            canvas.id = 'engagement-line-chart';
            container.appendChild(canvas);
          } else if (containerId === 'sources-chart') {
            const canvas = document.createElement('canvas');
            canvas.id = 'traffic-sources-chart';
            container.appendChild(canvas);
          } else {
            const canvas = document.createElement('canvas');
            canvas.id = `${containerId}-canvas`;
            container.appendChild(canvas);
          }
        }
      });
      
      // Add loading state for metrics container
      if (document.getElementById('engagement-metrics')) {
        document.getElementById('engagement-metrics').innerHTML = '<div class="loading">Loading metrics...</div>';
      }
      
      console.log(`Loading analytics data for business ID: ${businessId}`);
      
      // Call our API
      fetch(`/api/analytics/business/${businessId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to load analytics data');
          }
          return response.json();
        })
        .then(data => {
          analyticsData = data;
          displayAnalyticsData(data);
        })
        .catch(error => {
          console.error('Error loading analytics data:', error);
          showNotification('Failed to load analytics data. Using sample data.', 'error');
          
          // Load mock data if API fails
          analyticsData = getMockAnalyticsData(businessId);
          displayAnalyticsData(analyticsData);
        });
    }
    
    function displayAnalyticsData(data) {
      // Update summary stats
      document.getElementById('total-competitions').textContent = data.totalCompetitions;
      document.getElementById('total-submissions').textContent = data.totalSubmissions;
      document.getElementById('total-views').textContent = data.totalViews;
      document.getElementById('avg-engagement').textContent = data.avgEngagement;
      
      // Update analytics table
      const tableBody = document.getElementById('analytics-table-body');
      if (tableBody) {
        tableBody.innerHTML = '';
        
        data.competitions.forEach(comp => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${comp.title}</td>
            <td>${comp.submissions}</td>
            <td>${comp.views}</td>
            <td>${comp.engagementRate}</td>
          `;
          tableBody.appendChild(row);
        });
      }
      
      // Update enhanced engagement metrics if they exist
      if (data.engagement) {
        if (document.getElementById('daily-engagement')) {
          document.getElementById('daily-engagement').textContent = data.engagement.daily[data.engagement.daily.length - 1];
        }
        if (document.getElementById('weekly-trend')) {
          document.getElementById('weekly-trend').textContent = `+${data.engagement.weeklyTrend}%`;
        }
        if (document.getElementById('conversion-rate')) {
          document.getElementById('conversion-rate').textContent = `${data.engagement.conversionRate}%`;
        }
        if (document.getElementById('avg-time')) {
          document.getElementById('avg-time').textContent = `${data.engagement.avgTimeSpent} min`;
        }
      }
      
      // Update traffic sources if they exist
      if (data.trafficSources && document.getElementById('traffic-sources-list')) {
        const trafficSourcesList = document.getElementById('traffic-sources-list');
        trafficSourcesList.innerHTML = '<h4>Traffic Sources</h4>';
        
        data.trafficSources.forEach(source => {
          const sourceItem = document.createElement('div');
          sourceItem.className = 'source-item';
          sourceItem.innerHTML = `
            <span class="source-name">${source.name}</span>
            <span class="source-percentage">${source.percentage}%</span>
          `;
          trafficSourcesList.appendChild(sourceItem);
        });
      }
      
      // Update session data
      if (data.sessionDuration && document.getElementById('session-duration')) {
        document.getElementById('session-duration').textContent = data.sessionDuration;
      }
      
      if (data.peakActivity && document.getElementById('peak-time')) {
        document.getElementById('peak-time').textContent = data.peakActivity;
      }
      
      // Update user behavior insights if they exist
      if (data.userBehavior) {
        if (document.getElementById('returning-users')) {
          document.getElementById('returning-users').textContent = data.userBehavior.returningUsers || '68%';
        }
        if (document.getElementById('votes-per-user')) {
          document.getElementById('votes-per-user').textContent = data.userBehavior.votesPerUser || '8.2';
        }
        if (document.getElementById('submission-quality')) {
          document.getElementById('submission-quality').textContent = data.userBehavior.submissionQuality || '4.2★';
        }
        if (document.getElementById('user-retention')) {
          document.getElementById('user-retention').textContent = data.userBehavior.userRetention || '71%';
        }
        
        // Update user growth if available
        if (document.getElementById('user-growth') && data.userBehavior.userGrowth) {
          document.getElementById('user-growth').textContent = data.userBehavior.userGrowth;
        }
        
        // Update active days if available
        if (document.getElementById('active-days') && data.userBehavior.activeDays) {
          document.getElementById('active-days').textContent = data.userBehavior.activeDays;
        }
        
        // Update comment frequency if available
        if (document.getElementById('comment-frequency') && data.userBehavior.commentFrequency) {
          document.getElementById('comment-frequency').textContent = data.userBehavior.commentFrequency;
        }
        
        // Update trends
        const trendElements = document.querySelectorAll('.insight-trend');
        trendElements.forEach(el => {
          // Check if trend is positive or negative and add appropriate class
          const trendValue = el.textContent;
          if (trendValue.includes('+')) {
            el.classList.add('trend-up');
            el.classList.remove('trend-down');
          } else if (trendValue.includes('-')) {
            el.classList.add('trend-down');
            el.classList.remove('trend-up');
          }
        });
      }
      
      // Update device usage if data is available
      if (data.deviceData) {
        if (document.getElementById('mobile-percentage')) {
          document.getElementById('mobile-percentage').textContent = `${data.deviceData.mobile}%`;
        }
        if (document.getElementById('desktop-percentage')) {
          document.getElementById('desktop-percentage').textContent = `${data.deviceData.desktop}%`;
        }
        if (document.getElementById('tablet-percentage')) {
          document.getElementById('tablet-percentage').textContent = `${data.deviceData.tablet}%`;
        }
        
        // Create device usage chart
        createDeviceUsageChart(data.deviceData);
      }
      
      // Update competition performance metrics if available
      if (data.competitionPerformance) {
        if (document.getElementById('avg-submissions-per-competition')) {
          document.getElementById('avg-submissions-per-competition').textContent = 
            data.competitionPerformance.averageSubmissionsPerCompetition;
        }
        if (document.getElementById('submission-completion-rate')) {
          document.getElementById('submission-completion-rate').textContent = 
            data.competitionPerformance.submissionCompletionRate;
        }
        if (document.getElementById('avg-competition-duration')) {
          document.getElementById('avg-competition-duration').textContent = 
            data.competitionPerformance.averageCompetitionDuration;
        }
        if (document.getElementById('top-performing-category')) {
          document.getElementById('top-performing-category').textContent = 
            data.competitionPerformance.topPerformingCategory;
        }
      }
      
      // Update geographic regions if available
      if (data.geographicData && data.geographicData.regions) {
        const geoContainer = document.getElementById('geo-data-container');
        if (geoContainer) {
          geoContainer.innerHTML = ''; // Clear existing content
          
          data.geographicData.regions.forEach(region => {
            const regionItem = document.createElement('div');
            regionItem.className = 'region-item';
            regionItem.innerHTML = `
              <span class="region-name">${region.name}</span>
              <span class="region-percentage">${region.percentage}%</span>
            `;
            geoContainer.appendChild(regionItem);
          });
        }
      }
      
      // Update engagement metrics
      if (document.getElementById('engagement-metrics')) {
        updateEngagementMetrics(data.engagement || {});
      }
      
      // Update time spent and peak time statistics
      if (document.getElementById('peak-time')) {
        document.getElementById('peak-time').textContent = data.peakActivity || '2pm - 6pm';
      }
      if (document.getElementById('session-duration')) {
        document.getElementById('session-duration').textContent = data.sessionDuration || '4.5 min';
      }
      
      // Prepare canvas elements for all charts with correct IDs
      const competitionsCanvas = resetCanvasElement('competitions-chart-canvas');
      const demographicsCanvas = resetCanvasElement('demographics-chart-canvas');
      const timelineCanvas = resetCanvasElement('timeline-chart-canvas');
      const engagementCanvas = resetCanvasElement('engagement-line-chart');
      const sourcesCanvas = resetCanvasElement('traffic-sources-chart');
      
      // Log canvas elements for debugging
      console.log('Canvas elements found:', {
        competitions: Boolean(competitionsCanvas),
        demographics: Boolean(demographicsCanvas),
        timeline: Boolean(timelineCanvas),
        engagement: Boolean(engagementCanvas),
        sources: Boolean(sourcesCanvas)
      });
      
      // Create/update charts with a slight delay to ensure DOM is ready
      setTimeout(() => {
        if (competitionsCanvas) createCompetitionsChart(data.competitions);
        if (demographicsCanvas) createDemographicsChart(data.demographics);
        if (timelineCanvas) createTimelineChart(data.timeline);
        if (engagementCanvas && data.engagement) createEngagementChart(data.engagement);
        if (sourcesCanvas && data.trafficSources) createTrafficSourcesChart(data.trafficSources);
      }, 100);
    }
    
    function updateEngagementMetrics(engagementData) {
      const metricsContainer = document.getElementById('engagement-metrics');
      if (!metricsContainer) return;
      
      metricsContainer.innerHTML = `
        <div class="metric-card">
          <div class="metric-icon">📈</div>
          <div class="metric-info">
            <div class="metric-label">Weekly Trend</div>
            <div class="metric-value ${(engagementData.weeklyTrend > 0) ? 'trend-up' : 'trend-down'}">
              ${engagementData.weeklyTrend > 0 ? '+' : ''}${engagementData.weeklyTrend || '15'}%
            </div>
          </div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon">🔄</div>
          <div class="metric-info">
            <div class="metric-label">Conversion Rate</div>
            <div class="metric-value">${engagementData.conversionRate || '3.8'}%</div>
          </div>
        </div>
        
        <div class="metric-card">
          <div class="metric-icon">⏱️</div>
          <div class="metric-info">
            <div class="metric-label">Avg. Time Spent</div>
            <div class="metric-value">${engagementData.avgTimeSpent || '4.5'} min</div>
          </div>
        </div>
      `;
    }
    
    function createEngagementChart(engagementData) {
      // Get canvas element
      const canvas = document.getElementById('engagement-line-chart');
      if (!canvas) {
        console.error('Engagement chart canvas element not found');
        console.log('Looking for ID:', 'engagement-line-chart');
        return;
      }
      
      // Get 2D context
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        console.error('Could not get 2D context for engagement chart');
        return;
      }
      
      if (engagementChart) {
        engagementChart.destroy();
      }
      
      // Default data if not provided
      const dailyData = engagementData.daily || [12, 18, 22, 15, 25, 30, 28];
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      
      console.log('Creating engagement chart with daily data:', dailyData);
      
      engagementChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: days,
          datasets: [{
            label: 'Daily Engagement',
            data: dailyData,
            fill: true,
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderColor: 'rgb(59, 130, 246)',
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: 'rgb(59, 130, 246)'
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          },
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          }
        }
      });
    }
    
    function createDeviceUsageChart(deviceData) {
      // First, check if we need to create or reset the canvas
      const deviceChartContainer = document.getElementById('device-usage-chart');
      if (!deviceChartContainer) {
        console.error('Device usage chart container not found');
        return;
      }
      
      // Create a canvas if it doesn't exist
      let canvas = document.getElementById('device-usage-chart-canvas');
      if (!canvas) {
        // Clear the container and add a new canvas
        deviceChartContainer.innerHTML = '';
        canvas = document.createElement('canvas');
        canvas.id = 'device-usage-chart-canvas';
        deviceChartContainer.appendChild(canvas);
      }
      
      // Get 2D context
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        console.error('Could not get 2D context for device usage chart');
        return;
      }
      
      // Clear any existing chart
      if (deviceChart) {
        deviceChart.destroy();
      }
      
      console.log('Creating device usage chart with data:', deviceData);
      
      // Create the new chart
      deviceChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Mobile', 'Desktop', 'Tablet'],
          datasets: [{
            data: [deviceData.mobile, deviceData.desktop, deviceData.tablet],
            backgroundColor: [
              'rgba(59, 130, 246, 0.7)', // Blue for mobile
              'rgba(16, 185, 129, 0.7)', // Green for desktop
              'rgba(245, 158, 11, 0.7)'  // Orange for tablet
            ],
            borderColor: [
              'rgba(59, 130, 246, 1)',
              'rgba(16, 185, 129, 1)',
              'rgba(245, 158, 11, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw}%`;
                }
              }
            }
          },
          cutout: '60%'
        }
      });
    }
    
    function createTrafficSourcesChart(sourcesData) {
      // Get canvas element
      const canvas = document.getElementById('traffic-sources-chart');
      if (!canvas) {
        console.error('Traffic sources chart canvas not found');
        console.log('Looking for ID:', 'traffic-sources-chart');
        return;
      }
      
      // Get 2D context
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        console.error('Could not get 2D context for traffic sources chart');
        return;
      }
      
      if (sourcesChart) {
        sourcesChart.destroy();
      }
      
      // Default data if not provided
      const defaultSources = [
        { name: 'Organic Search', percentage: 45 },
        { name: 'Direct', percentage: 25 },
        { name: 'Social Media', percentage: 20 },
        { name: 'Referral', percentage: 10 }
      ];
      
      const sources = sourcesData || defaultSources;
      
      console.log('Creating traffic sources chart with data:', sources);
      
      sourcesChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: sources.map(source => source.name),
          datasets: [{
            data: sources.map(source => source.percentage),
            backgroundColor: [
              'rgba(59, 130, 246, 0.7)',
              'rgba(16, 185, 129, 0.7)',
              'rgba(245, 158, 11, 0.7)',
              'rgba(239, 68, 68, 0.7)'
            ],
            borderColor: [
              'rgba(59, 130, 246, 1)',
              'rgba(16, 185, 129, 1)',
              'rgba(245, 158, 11, 1)',
              'rgba(239, 68, 68, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
    
    function createCompetitionsChart(competitions) {
      console.log('Starting competitions chart creation');
      
      // Get canvas element
      const canvas = document.getElementById('competitions-chart-canvas');
      console.log('Looking for canvas with ID:', 'competitions-chart-canvas');
      console.log('Canvas found:', Boolean(canvas));
      
      if (!canvas) {
        console.error('Competition chart canvas not found');
        console.log('Available chart containers:', document.querySelectorAll('.chart-container').length);
        console.log('Contents of competitions-chart div:', document.getElementById('competitions-chart')?.innerHTML);
        return;
      }
      
      // Get 2D context
      const ctx = canvas.getContext('2d');
      console.log('Canvas context available:', Boolean(ctx));
      
      if (!ctx) {
        console.error('Could not get 2D context for competition chart');
        return;
      }
      
      if (competitionsChart) {
        competitionsChart.destroy();
      }
      
      console.log('Creating competitions chart with data:', competitions);
      competitionsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: competitions.map(comp => comp.title),
          datasets: [{
            label: 'Submissions',
            data: competitions.map(comp => comp.submissions),
            backgroundColor: 'rgba(59, 130, 246, 0.6)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
          }, {
            label: 'Views (divided by 10)',
            data: competitions.map(comp => comp.views / 10),
            backgroundColor: 'rgba(16, 185, 129, 0.6)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
    
    function createDemographicsChart(demographics) {
      // Get canvas element
      const canvas = document.getElementById('demographics-chart-canvas');
      if (!canvas) {
        console.error('Demographics chart canvas not found');
        return;
      }
      
      // Get 2D context
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        console.error('Could not get 2D context for demographics chart');
        return;
      }
      
      if (demographicsChart) {
        demographicsChart.destroy();
      }
      
      console.log('Creating demographics chart with data:', demographics);
      demographicsChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(demographics),
          datasets: [{
            data: Object.values(demographics),
            backgroundColor: [
              'rgba(59, 130, 246, 0.6)',
              'rgba(16, 185, 129, 0.6)',
              'rgba(249, 115, 22, 0.6)',
              'rgba(236, 72, 153, 0.6)',
              'rgba(139, 92, 246, 0.6)'
            ],
            borderColor: [
              'rgba(59, 130, 246, 1)',
              'rgba(16, 185, 129, 1)',
              'rgba(249, 115, 22, 1)',
              'rgba(236, 72, 153, 1)',
              'rgba(139, 92, 246, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
        }
      });
    }
    
    function createTimelineChart(timelineData) {
      // Get canvas element
      const canvas = document.getElementById('timeline-chart-canvas');
      if (!canvas) {
        console.error('Timeline chart canvas not found');
        return;
      }
      
      // Get 2D context
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        console.error('Could not get 2D context for timeline chart');
        return;
      }
      
      if (timelineChart) {
        timelineChart.destroy();
      }
      
      console.log('Creating timeline chart with data:', timelineData);
      timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: timelineData.dates,
          datasets: [{
            label: 'Submissions',
            data: timelineData.submissions,
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
          }, {
            label: 'Views',
            data: timelineData.views,
            backgroundColor: 'rgba(16, 185, 129, 0.2)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
    
    function exportAnalytics(format) {
      if (!analyticsData) {
        showNotification('No analytics data available to export', 'error');
        return;
      }
      
      switch(format) {
        case 'csv':
          exportCSV();
          break;
        case 'pdf':
          showNotification('PDF export functionality coming soon!');
          break;
        case 'json':
          exportJSON();
          break;
        default:
          showNotification('Unknown export format', 'error');
      }
    }
    
    function exportCSV() {
      // Create CSV content
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Competition,Submissions,Views,Engagement Rate\n";
      
      analyticsData.competitions.forEach(comp => {
        csvContent += `${comp.title},${comp.submissions},${comp.views},${comp.engagementRate}\n`;
      });
      
      // Create download link
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "analytics_export.csv");
      document.body.appendChild(link);
      
      // Trigger download and cleanup
      link.click();
      document.body.removeChild(link);
      
      showNotification('Analytics exported as CSV');
    }
    
    function exportJSON() {
      // Create JSON content
      const jsonContent = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(analyticsData, null, 2));
      
      // Create download link
      const link = document.createElement("a");
      link.setAttribute("href", jsonContent);
      link.setAttribute("download", "analytics_export.json");
      document.body.appendChild(link);
      
      // Trigger download and cleanup
      link.click();
      document.body.removeChild(link);
      
      showNotification('Analytics exported as JSON');
    }
    
    function getMockAnalyticsData(businessId) {
      // Mock data for business analytics
      if (businessId === 'mock-business-1') {
        return {
          totalCompetitions: 3,
          totalSubmissions: 42,
          totalViews: '1.2k',
          avgEngagement: '32%',
          competitions: [
            { title: 'Logo Design Challenge', submissions: 24, views: 487, engagementRate: '4.9%' },
            { title: 'Marketing Campaign Concept', submissions: 18, views: 378, engagementRate: '4.8%' }
          ],
          demographics: {
            '18-24': 25,
            '25-34': 42,
            '35-44': 18,
            '45-54': 10,
            '55+': 5
          },
          timeline: {
            dates: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            submissions: [5, 12, 18, 23, 29, 42],
            views: [120, 250, 380, 470, 580, 720]
          },
          // Enhanced engagement analytics data
          engagement: {
            daily: [15, 22, 18, 25, 30, 28, 32],
            weeklyTrend: 15,
            conversionRate: 3.8,
            avgTimeSpent: 4.5
          },
          trafficSources: [
            { name: 'Organic Search', percentage: 45 },
            { name: 'Direct', percentage: 25 },
            { name: 'Social Media', percentage: 20 },
            { name: 'Referral', percentage: 10 }
          ],
          userBehavior: {
            returningUsers: '68%',
            votesPerUser: '8.2',
            submissionQuality: '4.2★',
            userRetention: '71%',
            userGrowth: '+15% MoM',
            activeDays: '3.5 per week',
            commentFrequency: '2.3 per submission'
          },
          deviceData: {
            mobile: 63,
            desktop: 24,
            tablet: 13
          },
          competitionPerformance: {
            averageSubmissionsPerCompetition: '14',
            submissionCompletionRate: '87%',
            averageCompetitionDuration: '18 days',
            topPerformingCategory: 'Graphic Design'
          },
          geographicData: {
            regions: [
              { name: 'North America', percentage: 42 },
              { name: 'Europe', percentage: 28 },
              { name: 'Asia', percentage: 18 },
              { name: 'South America', percentage: 7 },
              { name: 'Other', percentage: 5 }
            ]
          },
          peakActivity: '2pm - 6pm',
          sessionDuration: '4.5 min'
        };
      } else {
        return {
          totalCompetitions: 1,
          totalSubmissions: 12,
          totalViews: '295',
          avgEngagement: '24%',
          competitions: [
            { title: 'Mobile App UI Challenge', submissions: 12, views: 295, engagementRate: '4.1%' }
          ],
          demographics: {
            '18-24': 32,
            '25-34': 38,
            '35-44': 15,
            '45-54': 10,
            '55+': 5
          },
          timeline: {
            dates: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            submissions: [0, 0, 4, 7, 10, 12],
            views: [0, 0, 90, 152, 217, 295]
          },
          // Enhanced engagement analytics data
          engagement: {
            daily: [8, 12, 10, 14, 17, 15, 18],
            weeklyTrend: 9,
            conversionRate: 2.5,
            avgTimeSpent: 3.2
          },
          trafficSources: [
            { name: 'Organic Search', percentage: 35 },
            { name: 'Direct', percentage: 30 },
            { name: 'Social Media', percentage: 25 },
            { name: 'Referral', percentage: 10 }
          ],
          userBehavior: {
            returningUsers: '52%',
            votesPerUser: '5.1',
            submissionQuality: '3.8★',
            userRetention: '62%',
            userGrowth: '+8% MoM',
            activeDays: '2.1 per week',
            commentFrequency: '1.5 per submission'
          },
          deviceData: {
            mobile: 72,
            desktop: 18,
            tablet: 10
          },
          competitionPerformance: {
            averageSubmissionsPerCompetition: '9',
            submissionCompletionRate: '74%',
            averageCompetitionDuration: '14 days',
            topPerformingCategory: 'UI/UX Design'
          },
          geographicData: {
            regions: [
              { name: 'North America', percentage: 38 },
              { name: 'Europe', percentage: 25 },
              { name: 'Asia', percentage: 24 },
              { name: 'South America', percentage: 8 },
              { name: 'Other', percentage: 5 }
            ]
          },
          peakActivity: '3pm - 7pm',
          sessionDuration: '3.8 min'
        };
      }
    }
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    });
    
    // PWA Service Worker Registration and Offline Detection
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // Check initial online status and update UI
        updateOnlineStatus();
        
        // Add event listeners for online/offline status changes
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        navigator.serviceWorker.register('/service-worker.js')
          .then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
            
            // Listen for messages from service worker (e.g., sync completed)
            navigator.serviceWorker.addEventListener('message', function(event) {
              console.log('Received message from service worker:', event.data);
              
              // Handle background sync completed messages
              if (event.data.type === 'SYNC_COMPLETED') {
                const { type, count } = event.data.data;
                
                if (type === 'votes') {
                  showNotification(`${count} vote(s) successfully synchronized!`, 'success');
                } else if (type === 'submissions') {
                  showNotification(`${count} submission(s) successfully uploaded!`, 'success');
                }
              }
              
              // Handle badge count updates from service worker
              if (event.data.type === 'BADGE_COUNT_UPDATED') {
                const count = event.data.data.count;
                console.log('Received badge count update:', count);
                updateAppBadge(count);
              }
            });
            
            // Push notification setup
            setupPushNotifications(registration);
            
            // Add install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
              // Prevent Chrome 67 and earlier from automatically showing the prompt
              e.preventDefault();
              // Stash the event so it can be triggered later
              deferredPrompt = e;
              
              // Show the install prompt if not already installed
              setTimeout(() => {
                // Check if we should show install prompt (not already added to home screen)
                if (deferredPrompt) {
                  // Show the install prompt banner
                  const installPrompt = document.getElementById('install-prompt');
                  if (installPrompt) {
                    installPrompt.style.display = 'block';
                    
                    // Add event listener to install button
                    const installButton = document.getElementById('install-button');
                    if (installButton) {
                      installButton.addEventListener('click', () => {
                        // Hide the prompt
                        installPrompt.style.display = 'none';
                        
                        // Show the browser install prompt
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                          if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                            // Maybe show a thank you message
                            showNotification('App installed successfully!', 'success');
                          } else {
                            console.log('User dismissed the install prompt');
                          }
                          deferredPrompt = null;
                        });
                      });
                    }
                    
                    // Add event listener to dismiss button
                    const dismissButton = document.getElementById('dismiss-install');
                    if (dismissButton) {
                      dismissButton.addEventListener('click', () => {
                        installPrompt.style.display = 'none';
                        // Save in localStorage to not show again for some time
                        localStorage.setItem('installPromptDismissed', Date.now().toString());
                      });
                    }
                  }
                }
              }, 3000);
            });
          })
          .catch(function(error) {
            console.log('ServiceWorker registration failed: ', error);
          });
      });
    }
    
    // Push Notification Setup
    function setupPushNotifications(swRegistration) {
      // Check if push notifications are supported
      if (!('PushManager' in window)) {
        console.log('Push notifications not supported');
        return;
      }
      
      // Add notification button to profile section
      const profileSection = document.querySelector('#profile-screen .container');
      if (profileSection) {
        const notificationSection = document.createElement('div');
        notificationSection.className = 'card';
        notificationSection.innerHTML = `
          <h3>Notifications</h3>
          <p>Get notified about new competitions, updates, and results.</p>
          <button id="notification-permission-btn" class="primary">Enable Notifications</button>
        `;
        profileSection.appendChild(notificationSection);
        
        // Add event listener to notification permission button
        const notificationBtn = document.getElementById('notification-permission-btn');
        notificationBtn.addEventListener('click', () => {
          requestNotificationPermission(swRegistration);
        });
        
        // Update button text based on current permission
        updateNotificationButtonState(notificationBtn);
      }
    }
    
    // Request notification permission
    function requestNotificationPermission(swRegistration) {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          console.log('Notification permission granted');
          showNotification('Notifications enabled!', 'success');
          
          // Subscribe to push notifications
          subscribeToPushNotifications(swRegistration);
          
          // Update notification button
          const notificationBtn = document.getElementById('notification-permission-btn');
          if (notificationBtn) {
            updateNotificationButtonState(notificationBtn);
          }
          
          // Send test notification after a short delay
          setTimeout(() => {
            showPushNotification('Welcome to CreativeCrowdChallenge!', {
              body: 'You will now receive updates about new competitions and events.',
              icon: '/assets/icon-192x192.png',
              badge: '/assets/icon-192x192.png'
            });
          }, 2000);
        } else {
          console.log('Notification permission denied');
          showNotification('Notification permission denied', 'error');
        }
      });
    }
    
    // Update notification button state
    function updateNotificationButtonState(button) {
      if (Notification.permission === 'granted') {
        button.textContent = 'Notifications Enabled';
        button.disabled = true;
        button.classList.add('success');
      } else {
        button.textContent = 'Enable Notifications';
        button.disabled = false;
        button.classList.remove('success');
      }
    }
    
    // Subscribe to push notifications
    function subscribeToPushNotifications(swRegistration) {
      // This would typically create a subscription and send to server
      // For demo purposes, we'll just log it
      console.log('Would subscribe to push notifications here');
      
      // In a real app, you would use:
      /*
      swRegistration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array('your-public-key')
      })
      .then(subscription => {
        // Send subscription to your server
        console.log('User subscribed:', subscription);
      })
      */
    }
    
    // Show push notification
    function showPushNotification(title, options) {
      if (Notification.permission === 'granted') {
        navigator.serviceWorker.ready.then(registration => {
          registration.showNotification(title, options);
        });
      }
    }
    
    // Update app badge (if supported)
    function updateAppBadge(count) {
      if ('setAppBadge' in navigator) {
        if (count > 0) {
          navigator.setAppBadge(count).catch(error => {
            console.error('Error setting app badge:', error);
          });
        } else {
          navigator.clearAppBadge().catch(error => {
            console.error('Error clearing app badge:', error);
          });
        }
      } else {
        console.log('App Badge API not supported in this browser');
      }
    }
    
    // Function to check online status and update the UI
    function updateOnlineStatus() {
      const offlineNotification = document.getElementById('offline-notification');
      
      if (navigator.onLine) {
        // User is online
        offlineNotification.style.display = 'none';
        console.log('Application is online');
      } else {
        // User is offline
        offlineNotification.style.display = 'block';
        console.log('Application is offline');
      }
    }
    
    // Show Analytics Request Form for business users
    // Function to save analytics request in local storage when server request fails
    function saveAnalyticsRequestLocally(requestData) {
      try {
        // Get existing requests or initialize empty array
        const existingRequests = JSON.parse(localStorage.getItem('analyticsRequests') || '[]');
        
        // Add new request
        existingRequests.push(requestData);
        
        // Save back to localStorage
        localStorage.setItem('analyticsRequests', JSON.stringify(existingRequests));
        
        console.log('Analytics request saved locally for later synchronization');
      } catch (error) {
        console.error('Error saving analytics request locally:', error);
      }
    }
    
    // Function to show the analytics request form
    function showRequestAnalyticsForm() {
      console.log('Opening Analytics Request Form');
      
      // Create modal for analytics request
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <span class="close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
          <h2>Request Analytics Report</h2>
          <p>Complete this form to request an analytics report for your business competitions. An administrator will review your request and provide access to the analytics dashboard.</p>
          
          <form id="analytics-request-form" style="margin-top: 20px;">
            <div class="form-group">
              <label for="request-business-name">Business Name</label>
              <input type="text" id="request-business-name" placeholder="Your business name" required>
            </div>
            
            <div class="form-group">
              <label for="request-competition">Competition</label>
              <select id="request-competition" required>
                <option value="">Select a competition</option>
                <option value="all">All my competitions</option>
                <option value="Logo Design Challenge">Logo Design Challenge</option>
                <option value="Mobile App UI Challenge">Mobile App UI Challenge</option>
                <option value="Marketing Campaign Concept">Marketing Campaign Concept</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="request-timeframe">Time Period</label>
              <select id="request-timeframe" required>
                <option value="last7days">Last 7 days</option>
                <option value="last30days" selected>Last 30 days</option>
                <option value="last90days">Last 90 days</option>
                <option value="custom">Custom date range</option>
              </select>
            </div>
            
            <div id="custom-dates" class="form-group" style="display: none;">
              <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                  <label for="request-start-date">Start Date</label>
                  <input type="date" id="request-start-date">
                </div>
                <div style="flex: 1;">
                  <label for="request-end-date">End Date</label>
                  <input type="date" id="request-end-date">
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label for="request-notes">Additional Notes</label>
              <textarea id="request-notes" rows="3" placeholder="Any specific metrics or insights you're looking for"></textarea>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
              <button type="submit" class="primary">Submit Request</button>
              <button type="button" onclick="this.closest('.modal').style.display='none'" class="secondary">Cancel</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Add event listener for custom date range
      const timeframeSelect = document.getElementById('request-timeframe');
      const customDatesDiv = document.getElementById('custom-dates');
      
      timeframeSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
          customDatesDiv.style.display = 'block';
        } else {
          customDatesDiv.style.display = 'none';
        }
      });
      
      // Add form submission handler
      const form = document.getElementById('analytics-request-form');
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form values
        const businessName = document.getElementById('request-business-name').value;
        const competition = document.getElementById('request-competition').value;
        const timeframe = document.getElementById('request-timeframe').value;
        const notes = document.getElementById('request-notes').value;
        
        // Prepare request data
        const requestData = {
          id: 'req_' + Date.now(), // Generate a unique ID
          businessName,
          competition,
          timeframe,
          notes,
          userId: currentUser?.id || 'guest',
          userName: currentUser?.name || 'Guest User',
          status: 'pending',
          requestDate: new Date().toISOString(),
          userEmail: currentUser?.email || ''
        };
        
        // Custom date range handling
        if (timeframe === 'custom') {
          const startDate = document.getElementById('request-start-date').value;
          const endDate = document.getElementById('request-end-date').value;
          requestData.startDate = startDate;
          requestData.endDate = endDate;
        }
        
        // Submit analytics request to server
        fetch('/api/analytics/request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to submit analytics request');
          }
          return response.json();
        })
        .then(data => {
          console.log('Analytics request submitted successfully:', data);
          
          // Close the modal
          modal.style.display = 'none';
          
          // Show confirmation notification
          showNotification('Your analytics report request has been submitted. An administrator will review your request shortly.', 'success');
        })
        .catch(error => {
          console.error('Error submitting analytics request:', error);
          
          // Save request locally if server submission fails
          saveAnalyticsRequestLocally(requestData);
          
          // Close the modal
          modal.style.display = 'none';
          
          // Show confirmation notification (still show success to user)
          showNotification('Your analytics report request has been submitted. An administrator will review your request shortly.', 'success');
        });
      });
      
      // Pre-fill form with user data if available
      if (currentUser) {
        const businessNameInput = document.getElementById('request-business-name');
        if (businessNameInput && currentUser.businessName) {
          businessNameInput.value = currentUser.businessName;
        }
      }
    }
  </script>
  
  <!-- Footer -->
  <footer style="text-align: center; padding: 20px; margin-top: 40px; color: #6B7280; font-size: 14px; border-top: 1px solid #E5E7EB;">
    <p>© 2025 CreativeCrowdChallenge. All rights reserved.</p>
    <p style="margin-top: 10px; font-size: 12px;">
      <a href="/" style="color: #6B7280; margin: 0 10px;">Home</a>
      <a href="#" id="privacy-link" style="color: #6B7280; margin: 0 10px;">Privacy Policy</a>
      <a href="#" id="terms-link" style="color: #6B7280; margin: 0 10px;">Terms of Service</a>
      <a href="/admin" id="admin-link" style="color: #6B7280; margin: 0 10px; opacity: 0.7;">Admin</a>
    </p>
  </footer>
</body>
</html>