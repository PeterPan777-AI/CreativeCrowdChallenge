<!DOCTYPE html>
<html>
<head>
  <title>Admin Login - CreativeCrowdChallenge</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Admin access for CreativeCrowdChallenge platform">
  <meta name="theme-color" content="#3b82f6">
  <link rel="manifest" href="/manifest.json">
  
  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CreativeCC Admin">
  <link rel="apple-touch-icon" href="/assets/icon-192x192.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/assets/icon-192x192.png">
  
  <style>
    /* Base styles */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    /* Header */
    header {
      background-color: #1E3A8A;
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    
    /* Container */
    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      flex: 1;
    }
    
    /* Card styles */
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    /* Button styles */
    button {
      background-color: #1E3A8A;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
      width: 100%;
      margin-top: 20px;
    }
    
    button:hover {
      background-color: #1E40AF;
    }
    
    /* Specialized button styles */
    .approve-btn, .view-btn, .action-button {
      background-color: #059669;
      width: auto;
      margin-right: 10px;
    }
    
    .approve-btn:hover, .view-btn:hover, .action-button:hover {
      background-color: #047857;
    }
    
    .decline-btn, .revoke-btn {
      background-color: #DC2626;
      width: auto;
    }
    
    .decline-btn:hover, .revoke-btn:hover {
      background-color: #B91C1C;
    }
    
    .logout-button {
      background-color: #6B7280;
      width: auto;
    }
    
    .logout-button:hover {
      background-color: #4B5563;
    }
    
    /* Form styles */
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    /* Admin dashboard stats */
    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .stat-card {
      background-color: #f8fafc;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border-left: 4px solid #3B82F6;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #1E40AF;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #64748b;
      font-size: 14px;
    }
    
    /* Analytics request cards */
    .request-section {
      margin-bottom: 30px;
    }
    
    .request-section h3 {
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 10px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    
    .badge {
      background-color: #3B82F6;
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      margin-left: 10px;
    }
    
    .request-card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.2s;
    }
    
    .request-card:hover {
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transform: translateY(-2px);
    }
    
    .request-card.approved {
      border-left: 4px solid #10B981;
    }
    
    .request-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .request-header h4 {
      margin: 0;
      color: #1E40AF;
    }
    
    .request-date {
      color: #6B7280;
      font-size: 14px;
    }
    
    .request-details {
      margin-bottom: 15px;
    }
    
    .request-details p {
      margin: 5px 0;
      font-size: 14px;
    }
    
    .request-actions {
      display: flex;
      justify-content: flex-end;
    }
    
    /* Error and info messages */
    .message {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .error {
      background-color: #FEE2E2;
      border: 1px solid #EF4444;
      color: #B91C1C;
    }
    
    .info {
      background-color: #DBEAFE;
      border: 1px solid #3B82F6;
      color: #1E40AF;
    }
    
    /* Footer */
    footer {
      text-align: center;
      padding: 20px;
      color: #6B7280;
      font-size: 14px;
      border-top: 1px solid #E5E7EB;
      margin-top: auto;
    }
    
    /* Logo */
    .admin-logo {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .admin-logo span {
      color: #3B82F6;
    }
    
    /* Notification styling */
    #notification {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      display: none;
    }
    
    #notification.success {
      background-color: #D1FAE5;
      border: 1px solid #10B981;
      color: #065F46;
    }
    
    #notification.error {
      background-color: #FEE2E2;
      border: 1px solid #EF4444;
      color: #B91C1C;
    }
  </style>
</head>
<body>
  <header>
    <h1>Admin Portal</h1>
    <a href="/" class="back-button" style="color: white; text-decoration: none; position: absolute; left: 20px; top: 50%; transform: translateY(-50%);">
      &larr; Back to Site
    </a>
  </header>
  
  <div class="container">
    <!-- Login Form - Shown by default -->
    <div id="login-section" class="card">
      <div class="admin-logo">Creative<span>CC</span> Admin</div>
      <p style="color: #6B7280; margin-bottom: 20px;">
        Please enter your administrator credentials to access the management console.
      </p>
      
      <div id="notification"></div>
      
      <form id="admin-login-form">
        <div class="form-group">
          <label for="admin-email">Email</label>
          <input type="email" id="admin-email" required placeholder="admin@example.com">
        </div>
        
        <div class="form-group">
          <label for="admin-password">Password</label>
          <input type="password" id="admin-password" required placeholder="•••••••••••">
        </div>
        
        <button type="submit" id="admin-login-button">Log In</button>
      </form>
    </div>
    
    <!-- Admin Dashboard - Hidden by default -->
    <div id="admin-dashboard" style="display: none;">
      <div class="card">
        <h2>Admin Dashboard</h2>
        <p>Welcome to the administrator dashboard. Manage platform operations from here.</p>
        
        <div class="admin-stats">
          <div class="stat-card">
            <div class="stat-value">42</div>
            <div class="stat-label">Active Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">18</div>
            <div class="stat-label">Competitions</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">7</div>
            <div class="stat-label">Business Accounts</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">3</div>
            <div class="stat-label">Analytics Requests</div>
          </div>
        </div>
      </div>
      
      <!-- Analytics Requests Management -->
      <div class="card">
        <h2>Analytics Requests</h2>
        <p>Review and manage analytics requests from business users.</p>
        
        <div id="analytics-requests-container">
          <!-- New Requests Section -->
          <div class="request-section">
            <h3>New Requests <span class="badge">2</span></h3>
            
            <div class="request-card">
              <div class="request-header">
                <h4>TechCreate Solutions</h4>
                <span class="request-date">March 23, 2025</span>
              </div>
              <div class="request-details">
                <p><strong>Competition:</strong> Logo Design Challenge</p>
                <p><strong>Time Period:</strong> Last 30 days</p>
                <p><strong>Notes:</strong> Looking for detailed engagement metrics and participant demographics.</p>
              </div>
              <div class="request-actions">
                <button class="approve-btn" onclick="approveAnalyticsRequest('request-1')">Approve</button>
                <button class="decline-btn" onclick="declineAnalyticsRequest('request-1')">Decline</button>
              </div>
            </div>
            
            <div class="request-card">
              <div class="request-header">
                <h4>EcoDesign Innovations</h4>
                <span class="request-date">March 22, 2025</span>
              </div>
              <div class="request-details">
                <p><strong>Competition:</strong> All competitions</p>
                <p><strong>Time Period:</strong> Last 90 days</p>
                <p><strong>Notes:</strong> Need comprehensive performance data for quarterly business review.</p>
              </div>
              <div class="request-actions">
                <button class="approve-btn" onclick="approveAnalyticsRequest('request-2')">Approve</button>
                <button class="decline-btn" onclick="declineAnalyticsRequest('request-2')">Decline</button>
              </div>
            </div>
          </div>
          
          <!-- Approved Requests Section -->
          <div class="request-section">
            <h3>Approved Requests <span class="badge">1</span></h3>
            
            <div class="request-card approved">
              <div class="request-header">
                <h4>DigitalFusion Group</h4>
                <span class="request-date">March 20, 2025</span>
              </div>
              <div class="request-details">
                <p><strong>Competition:</strong> Mobile App UI Challenge</p>
                <p><strong>Time Period:</strong> Last 30 days</p>
                <p><strong>Status:</strong> Approved on March 21, 2025</p>
              </div>
              <div class="request-actions">
                <button class="view-btn" onclick="viewAnalyticsReport('report-1')">View Report</button>
                <button class="revoke-btn" onclick="revokeAnalyticsAccess('report-1')">Revoke Access</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Main Analytics Dashboard -->
      <div class="card">
        <h2>Platform Analytics</h2>
        <p>Monitor and analyze platform-wide metrics and performance data.</p>
        <button onclick="viewPlatformAnalytics()" class="action-button">View Full Analytics Dashboard</button>
      </div>
      
      <div class="card">
        <h2>Account Management</h2>
        <button onclick="logout()" class="logout-button">Logout</button>
      </div>
    </div>
  </div>
  
  <footer>
    <p>© 2025 CreativeCrowdChallenge. All rights reserved.</p>
    <p style="margin-top: 10px; font-size: 12px;">
      <a href="/" style="color: #6B7280; margin: 0 10px;">Home</a>
      <a href="#" id="privacy-link" style="color: #6B7280; margin: 0 10px;">Privacy Policy</a>
      <a href="#" id="terms-link" style="color: #6B7280; margin: 0 10px;">Terms of Service</a>
    </p>
  </footer>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const adminLoginForm = document.getElementById('admin-login-form');
      const notification = document.getElementById('notification');
      const loginSection = document.getElementById('login-section');
      const adminDashboard = document.getElementById('admin-dashboard');
      
      // Check if already logged in
      const checkAdminLogin = () => {
        const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
        if (currentUser && currentUser.email && currentUser.role === 'admin') {
          // Show admin dashboard
          loginSection.style.display = 'none';
          adminDashboard.style.display = 'block';
          return true;
        }
        return false;
      };
      
      // Try to load dashboard if logged in
      if (checkAdminLogin()) {
        // Already logged in, so no need for further login actions
        console.log('Admin already logged in');
        
        // Load analytics requests for the admin dashboard
        setTimeout(() => {
          loadAnalyticsRequests();
        }, 300);
      }
      
      // Handle admin login form submission
      adminLoginForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        
        if (!email || !password) {
          showNotification('Please enter both email and password.', 'error');
          return;
        }
        
        try {
          // Check if email contains 'admin' to determine if it's an admin account
          if (!email.includes('admin')) {
            showNotification('Invalid admin credentials. Please use an admin account.', 'error');
            return;
          }
          
          // Make the login request to the server
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password }),
          });
          
          const data = await response.json();
          
          if (response.ok) {
            // Check if the logged-in user is an admin
            if (data.user && (data.user.role === 'admin' || data.user.email.includes('admin'))) {
              showNotification('Login successful!', 'success');
              
              // Store user data in localStorage using key 'user' to maintain consistency with main app
              localStorage.setItem('user', JSON.stringify({
                ...data.user,
                role: 'admin' // Ensure role is set properly
              }));
              
              // Show admin dashboard
              setTimeout(() => {
                loginSection.style.display = 'none';
                adminDashboard.style.display = 'block';
                
                // Load analytics requests
                loadAnalyticsRequests();
              }, 1000);
            } else {
              showNotification('This account does not have admin privileges.', 'error');
            }
          } else {
            showNotification(data.message || 'Login failed. Please check your credentials.', 'error');
          }
        } catch (error) {
          console.error('Login error:', error);
          
          // Handle offline case (demo mode)
          if (!navigator.onLine) {
            // For demo purposes, check if using admin credentials
            if (email.includes('admin')) {
              // Create a mock admin user for demo
              const mockAdminUser = {
                id: 'admin-123',
                email: email,
                role: 'admin',
                name: 'Admin User',
                avatar: null
              };
              
              localStorage.setItem('user', JSON.stringify(mockAdminUser));
              
              showNotification('Demo mode: Admin login successful!', 'success');
              setTimeout(() => {
                loginSection.style.display = 'none';
                adminDashboard.style.display = 'block';
                
                // Load analytics requests for demo admin
                loadAnalyticsRequests();
              }, 1000);
            } else {
              showNotification('Please use an admin account (containing "admin" in the email).', 'error');
            }
          } else {
            showNotification('Login failed. Please try again later.', 'error');
          }
        }
      });
      
      // Analytics request management functions
      // Load analytics requests from the API
      async function loadAnalyticsRequests() {
        const pendingContainer = document.querySelector('.request-section:nth-of-type(1)');
        const approvedContainer = document.querySelector('.request-section:nth-of-type(2)');
        
        if (!pendingContainer || !approvedContainer) {
          console.error('Request containers not found');
          return;
        }
        
        // Clear existing requests (except headers)
        const pendingHeader = pendingContainer.querySelector('h3');
        const approvedHeader = approvedContainer.querySelector('h3');
        
        pendingContainer.innerHTML = '';
        approvedContainer.innerHTML = '';
        
        // Re-add headers
        pendingContainer.appendChild(pendingHeader);
        approvedContainer.appendChild(approvedHeader);
        
        try {
          // Get current user info
          const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
          if (!currentUser || !currentUser.id || currentUser.role !== 'admin') {
            showNotification('Admin access required', 'error');
            return;
          }
          
          // Add loading indicator
          const pendingLoading = document.createElement('div');
          pendingLoading.className = 'message info';
          pendingLoading.textContent = 'Loading analytics requests...';
          pendingContainer.appendChild(pendingLoading);
          
          // Call the API to get all analytics requests (admins can see all requests)
          const response = await fetch('/api/analytics/requests', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'X-User-Id': currentUser.id,
              'X-User-Role': 'admin'
            }
          });
          
          if (!response.ok) {
            throw new Error('Failed to load analytics requests');
          }
          
          const requests = await response.json();
          console.log('Loaded analytics requests:', requests);
          
          // Remove loading indicator
          pendingContainer.removeChild(pendingLoading);
          
          // Group requests by status
          const pendingRequests = requests.filter(req => req.status === 'pending');
          const approvedRequests = requests.filter(req => req.status === 'approved');
          const declinedRequests = requests.filter(req => req.status === 'declined');
          
          // Update badges
          pendingHeader.innerHTML = `New Requests <span class="badge">${pendingRequests.length}</span>`;
          approvedHeader.innerHTML = `Approved & Declined Requests <span class="badge">${approvedRequests.length + declinedRequests.length}</span>`;
          
          // No pending requests message
          if (pendingRequests.length === 0) {
            const noRequests = document.createElement('div');
            noRequests.className = 'message info';
            noRequests.textContent = 'No pending analytics requests.';
            pendingContainer.appendChild(noRequests);
          }
          
          // No approved requests message
          if (approvedRequests.length === 0) {
            const noApproved = document.createElement('div');
            noApproved.className = 'message info';
            noApproved.textContent = 'No approved analytics requests.';
            approvedContainer.appendChild(noApproved);
          }
          
          // Create request cards
          pendingRequests.forEach(request => {
            const requestCard = createRequestCard(request, 'pending');
            pendingContainer.appendChild(requestCard);
          });
          
          approvedRequests.forEach(request => {
            const requestCard = createRequestCard(request, 'approved');
            approvedContainer.appendChild(requestCard);
          });
          
          // Display declined requests
          declinedRequests.forEach(request => {
            const requestCard = createRequestCard(request, 'declined');
            approvedContainer.appendChild(requestCard);
          });
          
        } catch (error) {
          console.error('Error loading analytics requests:', error);
          showNotification('Failed to load analytics requests: ' + error.message, 'error');
          
          // Display error message in containers
          const errorMessage = document.createElement('div');
          errorMessage.className = 'message error';
          errorMessage.textContent = 'Failed to load analytics requests. Please try again later.';
          pendingContainer.appendChild(errorMessage.cloneNode(true));
        }
      }
      
      // Create a request card element
      function createRequestCard(request, type) {
        const requestCard = document.createElement('div');
        // Add appropriate class based on status
        if (type === 'approved') {
          requestCard.className = 'request-card approved';
        } else if (request.status === 'declined') {
          requestCard.className = 'request-card declined';
        } else {
          requestCard.className = 'request-card';
        }
        requestCard.id = `request-card-${request.id}`;
        
        // Format date
        const requestDate = new Date(request.createdAt);
        const formattedDate = requestDate.toLocaleDateString('en-US', {
          month: 'long',
          day: 'numeric',
          year: 'numeric'
        });
        
        // Get competition info if available
        let competitionInfo = 'All competitions';
        if (request.competitionIds && request.competitionIds.length > 0) {
          // In a real app, we would look up the competition name from the ID
          competitionInfo = request.competitionIds[0];
        }
        
        // Format update date if available
        let updateDate = 'Unknown date';
        if (request.updatedAt) {
          const date = new Date(request.updatedAt);
          updateDate = date.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric'
          });
        }
        
        // Different content based on status
        if (type === 'pending') {
          requestCard.innerHTML = `
            <div class="request-header">
              <h4>${request.userEmail || 'Unknown User'}</h4>
              <span class="request-date">${formattedDate}</span>
            </div>
            <div class="request-details">
              <p><strong>Competition:</strong> ${competitionInfo}</p>
              <p><strong>Time Period:</strong> ${request.timeFrame}</p>
              <p><strong>Notes:</strong> ${request.description || 'No additional notes'}</p>
            </div>
            <div class="request-actions">
              <button class="approve-btn" onclick="approveAnalyticsRequest('${request.id}')">Approve</button>
              <button class="decline-btn" onclick="declineAnalyticsRequest('${request.id}')">Decline</button>
            </div>
          `;
        } else if (request.status === 'approved') {
          requestCard.innerHTML = `
            <div class="request-header">
              <h4>${request.userEmail || 'Unknown User'}</h4>
              <span class="request-date">${formattedDate}</span>
            </div>
            <div class="request-details">
              <p><strong>Competition:</strong> ${competitionInfo}</p>
              <p><strong>Time Period:</strong> ${request.timeFrame}</p>
              <p><strong>Status:</strong> <span class="status-approved">Approved</span> on ${updateDate}</p>
              ${request.adminNotes ? `<p><strong>Admin Notes:</strong> ${request.adminNotes}</p>` : ''}
            </div>
            <div class="request-actions">
              <button class="view-btn" onclick="viewAnalyticsReport('${request.id}')">View Report</button>
              <button class="revoke-btn" onclick="revokeAnalyticsAccess('${request.id}')">Revoke Access</button>
            </div>
          `;
        } else if (request.status === 'declined') {
          requestCard.innerHTML = `
            <div class="request-header">
              <h4>${request.userEmail || 'Unknown User'}</h4>
              <span class="request-date">${formattedDate}</span>
            </div>
            <div class="request-details">
              <p><strong>Competition:</strong> ${competitionInfo}</p>
              <p><strong>Time Period:</strong> ${request.timeFrame}</p>
              <p><strong>Status:</strong> <span class="status-declined">Declined</span> on ${updateDate}</p>
              ${request.adminNotes ? `<p><strong>Admin Notes:</strong> ${request.adminNotes}</p>` : ''}
            </div>
            <div class="request-actions">
              <button class="reconsider-btn" onclick="reconsiderAnalyticsRequest('${request.id}')">Reconsider</button>
            </div>
          `;
        }
        
        return requestCard;
      }
      
      // Approve an analytics request
      window.approveAnalyticsRequest = async function(requestId) {
        console.log(`Approving analytics request: ${requestId}`);
        
        try {
          // Get current user for admin validation
          const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
          if (!currentUser || currentUser.role !== 'admin') {
            showNotification('Admin access required', 'error');
            return;
          }
          
          // Find the request card
          const requestCard = document.getElementById(`request-card-${requestId}`);
          if (!requestCard) {
            showNotification('Request not found', 'error');
            return;
          }
          
          // Show loading state
          const actionButtons = requestCard.querySelector('.request-actions');
          const originalButtons = actionButtons.innerHTML;
          actionButtons.innerHTML = '<div class="message">Processing...</div>';
          
          // Get admin notes (in a real app, we would prompt for notes)
          const adminNotes = "Approved by administrator";
          
          // Call the API to update the request status
          const response = await fetch(`/api/analytics/request/${requestId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-User-Id': currentUser.id,
              'X-User-Role': 'admin'
            },
            body: JSON.stringify({
              status: 'approved',
              adminNotes
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to approve request');
          }
          
          const result = await response.json();
          console.log('Request approved:', result);
          
          // Show success notification
          showNotification('Analytics request approved successfully', 'success');
          
          // Reload all requests to reflect the changes
          loadAnalyticsRequests();
          
        } catch (error) {
          console.error('Error approving request:', error);
          showNotification('Failed to approve request: ' + error.message, 'error');
          
          // Restore the original buttons if we can find the card
          const requestCard = document.getElementById(`request-card-${requestId}`);
          if (requestCard) {
            const actionButtons = requestCard.querySelector('.request-actions');
            if (actionButtons) {
              actionButtons.innerHTML = `
                <button class="approve-btn" onclick="approveAnalyticsRequest('${requestId}')">Approve</button>
                <button class="decline-btn" onclick="declineAnalyticsRequest('${requestId}')">Decline</button>
              `;
            }
          }
        }
      };
      
      // Decline an analytics request
      window.declineAnalyticsRequest = async function(requestId) {
        console.log(`Declining analytics request: ${requestId}`);
        
        try {
          // Get current user for admin validation
          const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
          if (!currentUser || currentUser.role !== 'admin') {
            showNotification('Admin access required', 'error');
            return;
          }
          
          // Find the request card
          const requestCard = document.getElementById(`request-card-${requestId}`);
          if (!requestCard) {
            showNotification('Request not found', 'error');
            return;
          }
          
          // Show loading state
          const actionButtons = requestCard.querySelector('.request-actions');
          const originalButtons = actionButtons.innerHTML;
          actionButtons.innerHTML = '<div class="message">Processing...</div>';
          
          // Get admin notes (in a real app, we would prompt for the reason)
          const adminNotes = "Declined by administrator";
          
          // Call the API to update the request status
          const response = await fetch(`/api/analytics/request/${requestId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-User-Id': currentUser.id,
              'X-User-Role': 'admin'
            },
            body: JSON.stringify({
              status: 'declined',
              adminNotes
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to decline request');
          }
          
          const result = await response.json();
          console.log('Request declined:', result);
          
          // Show success notification
          showNotification('Analytics request declined', 'success');
          
          // Reload all requests to reflect the changes
          loadAnalyticsRequests();
          
        } catch (error) {
          console.error('Error declining request:', error);
          showNotification('Failed to decline request: ' + error.message, 'error');
          
          // Restore the original buttons if we can find the card
          const requestCard = document.getElementById(`request-card-${requestId}`);
          if (requestCard) {
            const actionButtons = requestCard.querySelector('.request-actions');
            if (actionButtons) {
              actionButtons.innerHTML = `
                <button class="approve-btn" onclick="approveAnalyticsRequest('${requestId}')">Approve</button>
                <button class="decline-btn" onclick="declineAnalyticsRequest('${requestId}')">Decline</button>
              `;
            }
          }
        }
      };
      
      window.viewAnalyticsReport = function(reportId) {
        // In a real app, this would navigate to the report or open a modal
        console.log(`Viewing analytics report: ${reportId}`);
        
        // Find the business name from the card
        const requestCard = document.querySelector(`.request-card:has(button[onclick*="${reportId}"])`);
        if (requestCard) {
          const businessName = requestCard.querySelector('h4').textContent;
          
          // Create an analytics dashboard modal
          const modal = document.createElement('div');
          modal.style.position = 'fixed';
          modal.style.top = '0';
          modal.style.left = '0';
          modal.style.width = '100%';
          modal.style.height = '100%';
          modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
          modal.style.zIndex = '1000';
          modal.style.display = 'flex';
          modal.style.justifyContent = 'center';
          modal.style.alignItems = 'center';
          
          modal.innerHTML = `
            <div style="background: white; border-radius: 8px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; padding: 20px; position: relative;">
              <button style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;" onclick="this.parentElement.parentElement.remove()">×</button>
              <h2>Analytics Report: ${businessName}</h2>
              <p>This is a preview of the analytics dashboard that will be shared with the business.</p>
              <div style="background-color: #f8fafc; border-radius: 8px; padding: 15px; margin: 20px 0;">
                <h3>Report Details</h3>
                <p><strong>Business:</strong> ${businessName}</p>
                <p><strong>Status:</strong> Active</p>
                <p><strong>Generated On:</strong> ${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>
              </div>
              <button onclick="window.open('/simple-test.html?analyticsDemo=true', '_blank')" style="background-color: #1E3A8A; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Open Full Analytics Dashboard</button>
            </div>
          `;
          
          document.body.appendChild(modal);
        }
      };
      
      window.revokeAnalyticsAccess = function(reportId) {
        // In a real app, this would make an API call to revoke access
        console.log(`Revoking analytics access: ${reportId}`);
        
        // Find the card
        const requestCard = document.querySelector(`.request-card:has(button[onclick*="${reportId}"])`);
        if (requestCard) {
          const businessName = requestCard.querySelector('h4').textContent;
          
          // Remove the card
          requestCard.remove();
          
          // Update badges
          updateRequestCounts();
          
          // Show notification
          showNotification(`Analytics access for ${businessName} has been revoked.`, 'success');
        }
      };
      
      window.viewPlatformAnalytics = function() {
        // Navigate to the platform-wide analytics dashboard
        window.location.href = '/?adminAnalytics=true';
      };
      
      window.logout = function() {
        // Clear user data from localStorage
        localStorage.removeItem('user');
        
        // Show login form
        loginSection.style.display = 'block';
        adminDashboard.style.display = 'none';
        
        // Show notification
        showNotification('You have been logged out.', 'success');
      };
      
      // Helper function to update request count badges
      function updateRequestCounts() {
        // Update new requests badge
        const newRequestsSection = document.querySelector('.request-section:first-of-type');
        const newRequestCards = newRequestsSection.querySelectorAll('.request-card');
        const newRequestsBadge = newRequestsSection.querySelector('.badge');
        newRequestsBadge.textContent = newRequestCards.length;
        
        // Update approved requests badge
        const approvedRequestsSection = document.querySelector('.request-section:nth-of-type(2)');
        const approvedRequestCards = approvedRequestsSection.querySelectorAll('.request-card');
        const approvedRequestsBadge = approvedRequestsSection.querySelector('.badge');
        approvedRequestsBadge.textContent = approvedRequestCards.length;
        
        // Update total count in admin stats
        const analyticsRequestsStats = document.querySelector('.stat-card:nth-of-type(4) .stat-value');
        analyticsRequestsStats.textContent = newRequestCards.length + approvedRequestCards.length;
      }
      
      // Make sure to use the window.approveAnalyticsRequest and window.declineAnalyticsRequest
      // functions defined below
      
      // Show notification function
      function showNotification(message, type) {
        notification.textContent = message;
        notification.className = type;
        notification.style.display = 'block';
        
        // Hide notification after 5 seconds
        setTimeout(() => {
          notification.style.display = 'none';
        }, 5000);
      }
    });
  </script>
</body>
</html>